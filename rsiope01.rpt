/TELA RESIDENT
фмммммммммммммммммммммммммммммммммммммммммммммммммммммммммммммммммммммммммммммм╣
Ё                                                                              Ё
Ё                                                                              Ё
цдддддддддд GERACAO DE ARQUIVO PARA IMPORTACAO DO SIOPE - RECEITA ддддддддддддд╢
Ё                                                                              Ё
Ё                                                                              Ё
Ё                                                                              Ё
Ё                                                                              Ё
Ё  Entidade <F2>   : __ _____________________________________________________  Ё
Ё                                                                              Ё
Ё                                                                              Ё
Ё  Mes             : __                                                        Ё
Ё                                                                              Ё
Ё                                                                              Ё
Ё                                                                              Ё
Ё                                                                              Ё
Ё                                                                              Ё
цдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
Ё                               <ESC>  Retorna                                 Ё
юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
/CONFIRMA RESIDENT
цдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
Ё______________________________________________________________________________Ё
юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
/MSG RESIDENT
зддддддддд GERACAO DE ARQUIVO PARA IMPORTACAO DO SIOPE - RECEITA дддддддддддд©
Ё                                                                            Ё
цдддддддддддддддддддддддддддддд SOLICITADO дддддддддддддддддддддддддддддддддд╢
Ё                                                                            Ё
Ё                                                                            Ё
Ё                            Receitas - SIOPE                                Ё
Ё                                                                            Ё
Ё                                                                            Ё
цдддддддддддддддддддддддддддддд PROCESSANDO ддддддддддддддддддддддддддддддддд╢
Ё                                                                            Ё
Ё                                                                            Ё
Ё                       Ч Gerando Arquivos Textos Ч                          Ё
Ё                                                                            Ё
Ё                                                                            Ё
Ё                           Lendo :  __________.                             Ё
Ё                                                                            Ё
юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
/HEADER RESIDENT
 -----------------------------------------------------------------------------------------------------------------
|                                                                                                                 |
|                          ___________________________________________________________                            |
|                                                                                                                 |
|                                                                                                                 |
|                   PENDENCIAS REFERENTE A GERACAO DE ARQUIVO TEXTO PARA O SIOPE - RECEITAS                       |
|                                                                                                                 |
|                          ___________________________________________________________                            |
| __/__/____                                                                                         Pagina ____. |
|-----------------------------------------------------------------------------------------------------------------|
/BODY RESIDENT
| _______________________________________________________________________________________________________________ |
/TOTAL RESIDENT
 -----------------------------------------------------------------------------------------------------------------
/*
#INCLUDE CONAM.LIB
#INCLUDE ZERAARQ.LIB
#INCLUDE CAMINHO.LIB

#COMMAND GRAVA_TEMPCALC
 INDICATE @GRAVA! FALSE
 
            INDICATE @GRAVA! AS (MID(!2,7,1)) IN '6.2.1.2-6.2.1.3'
 [~@GRAVA!] INDICATE @GRAVA! AS (MID(!2,7,1)) IN '5.2.1.1-5.2.1.2'
 [~@GRAVA!] INDICATE @GRAVA! AS !2 EQ 'MOVREC'
 [~@GRAVA!] INDICATE @GRAVA! AS !2 EQ 'PLANREC'
 [ @GRAVA!] BEGIN
             CLEAR TEMPCALC
             MOVE ST@CODIGO@ENTIDADE      TO TEMPCALC.COD_ENTIDADE
             MOVE ST@EXERCICIO@FINANCEIRO TO TEMPCALC.EXERCICIO
             MOVE ST@USUARIO              TO TEMPCALC.USUARIO
             MOVE !1                      TO TEMPCALC.CODIGO
             MOVE !3                      TO TEMPCALC.NUMERO
             FIND EQ TEMPCALC BY INDEX.1
             [ FOUND] BEGIN
                       INDICATE ERR FALSE
                       ON ERROR GOSUB CHECA_GRAVACAO
                       REREAD TEMPCALC
                      END
             
             CALC (TEMPCALC.VALOR + !4)   TO TEMPCALC.VALOR
             MOVE !5                      TO TEMPCALC.AUXILIAR
             SAVERECORD TEMPCALC
             UNLOCK
             ON ERROR OFF
            END
#ENDCOMMAND

//--!1 codigo cliente
//--!2 codigo padrao
//--!3 codigo dedutoria
//--!4 variavel destino codigo encontrado
#COMMAND BUSCA_CODIGO_SIOPE
#IFDEF ST@COD@REC@AUX
#ELSE
 STRING ST@COD@REC@AUX
#ENDIF
#IFDEF ST@COD@REC@ACHADO
#ELSE
 STRING ST@COD@REC@ACHADO
#ENDIF
 
 MOVEALL '' TO ST@COD@REC@AUX ST@COD@REC@ACHADO
 
 [~@NOVO_CNR!] MOVE      !2        TO ST@COD@REC@AUX
 [ @NOVO_CNR!] MOVE (MID(!2,14,1)) TO ST@COD@REC@AUX
 
 IF !3 NE '' BEGIN
              CLEAR RELSIOP
              MOVE PARGERAL.ESTADO    TO RELSIOP.UF
              MOVE PARGERAL.EXERCICIO TO RELSIOP.ANO
              MOVE ST_SISTEMA         TO RELSIOP.SISTEMA
              MOVE 'RECEITA'          TO RELSIOP.NATUREZA
              MOVE !3                 TO RELSIOP.CODIGO_TCE
              MOVE ''                 TO RELSIOP.CNR
              FIND EQ RELSIOP BY INDEX.2
              [ FOUND] MOVE RELSIOP.CODIGO_SIOP TO ST@COD@REC@ACHADO
             END
 
 IF ST@COD@REC@ACHADO EQ '' BEGIN
                             CLEAR RELSIOP
                             MOVE PARGERAL.ESTADO    TO RELSIOP.UF
                             MOVE PARGERAL.EXERCICIO TO RELSIOP.ANO
                             MOVE ST_SISTEMA         TO RELSIOP.SISTEMA
                             MOVE 'RECEITA'          TO RELSIOP.NATUREZA
                             MOVE !1                 TO RELSIOP.CODIGO_TCE
                             MOVE ''                 TO RELSIOP.CNR
                             FIND EQ RELSIOP BY INDEX.2
                             [ FOUND] MOVE RELSIOP.CODIGO_SIOP TO ST@COD@REC@ACHADO
                             [~FOUND] BEGIN
                                       CLEAR RELSIOP
                                       MOVE PARGERAL.ESTADO    TO RELSIOP.UF
                                       MOVE PARGERAL.EXERCICIO TO RELSIOP.ANO
                                       MOVE ST_SISTEMA         TO RELSIOP.SISTEMA
                                       MOVE 'RECEITA'          TO RELSIOP.NATUREZA
                                       MOVE ST@COD@REC@AUX     TO RELSIOP.CODIGO_TCE
                                       MOVE ''                 TO RELSIOP.CNR
                                       FIND EQ RELSIOP BY INDEX.2
                                       [ FOUND] MOVE RELSIOP.CODIGO_SIOP TO ST@COD@REC@ACHADO
                                      END
                            END
 
 IF ST@COD@REC@ACHADO NE '' MOVE ST@COD@REC@ACHADO TO !4
#ENDCOMMAND

STRING ST_PROPRIA_ENTIDADE ST_ARQUIVO 255 ST_AUX         ST_DIRETORIO 255 ST_EXERCICIO     ST_HORA             ST_COD_RECEITA_SIOPE
STRING ST_MES              ST_MINUTO      ST_NOME_MES    ST_PERIODO       ST_SEGUNDO       ST_ENTIDADE_SELECAO ST_VERSAO_SIOPE
STRING ST@NUMERO           ST@JUNCAO      ST@PAGINAS     ST_JUNTA     255 ST_JUNTANDO      ST_DATA             ST_ENTIDADE_SAUDE
STRING ST_MES_BUSCA        ST_COD_RECEITA ST_BIMESTRE    ST_BODY      255 ST_ENTIDADE_RPPS ST_TIPO_VALOR       ST_SISTEMA
STRING ST_COD_DEDUTORIA    ST_COD_PADRAO

DATE DT_DATA DT_DATA_FINAL DT_DATA_INICIO_ANO

INTEGER RECCOUNT IT@NUMERO IT_MES IT_MES_FINAL IT_AUX IT_VERSAO_LOA IT_MAXIMO_COLUNA

NUMBER NB_ARRECADADO NB_PREVISTO_ATUALIZADO

AUTOPAGE MSG
NAME JN_LENDO

AUTOPAGE HEADER
NAME JHD_PREFEITURA
NAME JHD_PERIODO JHD_DATA  JHD_PAGINA

AUTOPAGE BODY
NAME JBD_DESCRICAO

AUTOPAGE TELA
NAME JN_COD_ENTIDADE  JN_ENTIDADE
NAME JN_MES

PAGE SET TELA     AT  4  0 COLORS IT_COR_TARJA  IT_COR_MOLDURA
PAGE SET CONFIRMA AT 21 00 COLORS IT_COR_TARJA  IT_COR_MOLDURA
PAGE SET MSG      AT 05 01 COLORS IT_COR_TITULO IT_COR_TITULO

OPEN ARQ_PRN
OPEN ENTIDADE
OPEN TEMPCALC
OPEN RECEITAS
OPEN PLANO
OPEN MOVREC
OPEN MOVDREC
OPEN ATUAREC
OPEN VERSAO
OPEN PLANREC
OPEN RELSIOP
OPEN CADSIOP
ABRE_CONTACOR ST@EXERCICIO@FINANCEIRO CONTACOR

IF PARGERAL.COD_ENTIDADE NE '01' BEGIN
                                  ADVERTE 'PROGRAMA INDISPONIVEL PARA ESSA ENTIDADE'
                                  ABORT
                                 END
            
MOVE PARGERAL.COD_ENTIDADE TO ST_PROPRIA_ENTIDADE

INDICATE TCEMG! AS PARGERAL.ESTADO       EQ 'MG'
INDICATE PREFE! AS PARGERAL.COD_ENTIDADE EQ '01'

DEFINE_CODIGO_RECEITA PARGERAL.EXERCICIO

MOVE 'SIOPE' TO ST_SISTEMA

CLEAR ENTIDADE
MOVE ST@EXERCICIO@FINANCEIRO TO ENTIDADE.EXERCICIO 
REPEAT
 FIND GT ENTIDADE BY INDEX.1
 [ FOUND] INDICATE FOUND AS ENTIDADE.EXERCICIO EQ ST@EXERCICIO@FINANCEIRO
 [ FOUND] BEGIN
           IF ENTIDADE.TP_ENTIDADE EQ '1' MOVE ENTIDADE.CODIGO TO ST_ENTIDADE_RPPS
           IF ENTIDADE.TP_ENTIDADE EQ '2' MOVE ENTIDADE.CODIGO TO ST_ENTIDADE_SAUDE
          END
UNTIL [~FOUND]

[ PREFE!] BEGIN
           ADVERTE 'CERTIFIQUE-SE SE OS DADOS DAS DEMAIS ENTIDADES DO MUNICIPIO FORAM IMPORTADOS, PARA A CORRETA ALIMENTACAO DO SIOPE.'
          END

INICIO:
SCREENMODE IT_COR_TARJA ON
PAGE TELA

[ PREFE!] BEGIN
           ACCEPT JN_COD_ENTIDADE {AUTOCLEAR}
           [KEY.ESCAPE] ABORT
           IF JN_COD_ENTIDADE NE '' BEGIN
                                     COMZEROS JN_COD_ENTIDADE 2
                                     CLEAR ENTIDADE
                                     MOVE ST@EXERCICIO@FINANCEIRO TO ENTIDADE.EXERCICIO 
                                     MOVE JN_COD_ENTIDADE         TO ENTIDADE.CODIGO
                                     FIND EQ ENTIDADE BY INDEX.1
                                     [~FOUND] BEGIN
                                               ADVERTE 'ENTIDADE N▌O CADASTRADA'
                                               GOTO INICIO
                                              END
                                     MOVE ENTIDADE.DESCRICAO      TO JN_ENTIDADE
                                    END
           ELSE MOVE 'CONSOLIDADO' TO JN_ENTIDADE
          END
[~PREFE!] BEGIN
           MOVE PARGERAL.COD_ENTIDADE   TO JN_COD_ENTIDADE
           CLEAR ENTIDADE
           MOVE ST@EXERCICIO@FINANCEIRO TO ENTIDADE.EXERCICIO 
           MOVE JN_COD_ENTIDADE         TO ENTIDADE.CODIGO
           FIND EQ ENTIDADE BY INDEX.1
           MOVE ENTIDADE.DESCRICAO      TO JN_ENTIDADE
          END

IF JN_COD_ENTIDADE EQ '02' BEGIN
                            ADVERTE 'ENTIDADE SELECIONADA INVALIDA'
                            GOTO INICIO
                           END

INDICATE TODAS! AS JN_COD_ENTIDADE EQ ''
MOVE JN_COD_ENTIDADE TO ST_ENTIDADE_SELECAO

LB_MES:
REPEAT
 ACCEPT JN_MES
 [KEY.ESCAPE] ABORT
 COMZEROS JN_MES 2
 IF NOT JN_MES IN '02a04a06a08a10a12' BEGIN
                                       MENSAGEM 353
                                       CLEARFORM JN_MES
                                      END
UNTIL JN_MES NE ''


INDICATE LE_MOV! AS ((JN_COD_ENTIDADE       LE '01')  OR (PARGERAL.COD_ENTIDADE GT '01')) //--ler movimento da propria entidade
INDICATE LE_XML! AS ((PARGERAL.COD_ENTIDADE EQ '01') AND (ST_ENTIDADE_SELECAO   NE '01')) //--ler movimento de outra entidade

INDICATE TUDO_XML! FALSE
IF (OBTER_CONFIGURACAO('SIOPE_DADOS_XML',ST@CODIGO@ENTIDADE,ST@EXERCICIO@FINANCEIRO)) NE '' BEGIN
 INDICATE   LE_MOV! FALSE
 INDICATE   LE_XML! TRUE
 INDICATE TUDO_XML! TRUE
END

MOVE JN_MES             TO ST_MES
MOVE PARGERAL.EXERCICIO TO ST_JUNTANDO
MOVE PARGERAL.EXERCICIO TO ST_EXERCICIO

MOVEALL '' TO ST_NOME_MES ST_AUX
APPEND ST_NOME_MES 'JANEIRO A '
MONTH JN_MES ST_AUX
APPEND ST_NOME_MES ST_AUX ST_JUNTANDO

MOVE '01/01/' TO ST_DATA
APPEND ST_DATA PARGERAL.EXERCICIO
MOVE ST_DATA  TO DT_DATA_INICIO_ANO

MOVE '01/'    TO ST_DATA
IF ST_MES LT '12' APPEND ST_DATA (ST_MES + 1) '/' PARGERAL.EXERCICIO
IF ST_MES EQ '12' APPEND ST_DATA  '01' '/' (PARGERAL.EXERCICIO + 1)
MOVE ST_DATA TO DT_DATA_FINAL
CALC (DT_DATA_FINAL - 1) TO DT_DATA_FINAL

PAGE TELA
PAGE MSG
GOTOXY 25 0

MOVE 0 TO RECCOUNT
INDICATE GERRELAT! TRUE

PAGE TELA

PASTA_CAMINHO ST_ARQUIVO 'TEXTOS' ' ' ST@CODIGO@ENTIDADE

// chamar programa para atualizar depara
MOVE 0 TO CURRENT_IMAGE
PAGE TELA
MOVE 'ATZ_SIOP_CLIENTE ' TO ST_JUNTA
APPEND ST_JUNTA 'SFPM'
CHAIN WAIT ST_JUNTA EXPORT_ONLY
GET_CURRENT_DIRECTORY TO ST_JUNTA
APPEND ST_JUNTA '/relsiop'
ERASEFILE ST_JUNTA
//--

APPEND ST_ARQUIVO 'receita_siope.csv'
TRIM ST_ARQUIVO TO ST_ARQUIVO

MOVE 0 TO CURRENT_IMAGE
PAGE MSG

//--verificacao
GOSUB LB_VERIFICACAO
PAGE TELA
PAGE MSG
//--

APAGA_TEMPCALC

//--monta temporario
//--movimento de receita pegar at┌ mes 13, no mes 14 ┌ efetuado o encerramento
[ LE_XML!] BEGIN
            MOVE JN_MES TO IT_MES_FINAL

            FOR IT_MES FROM 1 TO IT_MES_FINAL
             MOVE IT_MES TO ST_MES_BUSCA
             COMZEROS ST_MES_BUSCA 2

             CLEAR CONTACOR
             CONSTRAINT_SET 1
             CONSTRAIN CONTACOR.ANO                    EQ ST_EXERCICIO
             CONSTRAIN CONTACOR.MES                    EQ ST_MES_BUSCA
             [~TCEMG!] CONSTRAIN CONTACOR.XML          EQ '06'
             [ TCEMG!] CONSTRAIN CONTACOR.XML          EQ '12'
             [~TODAS!] CONSTRAIN CONTACOR.COD_ENTIDADE EQ ST_ENTIDADE_SELECAO
             [~TUDO_XML!] CONSTRAIN CONTACOR.COD_ENTIDADE NE ST_PROPRIA_ENTIDADE
             CONSTRAINED_FIND FIRST CONTACOR BY INDEX.4
             WHILE [FOUND]
               CALC (JN_LENDO + 1) TO JN_LENDO
               KEYCHECK GOSUB LB_ROTINA_PARADA
               
               CLEAR PLANO
               MOVE PARGERAL.ESTADO    TO PLANO.UF
               MOVE PARGERAL.EXERCICIO TO PLANO.ANO
               MOVE CONTACOR.CONTA     TO PLANO.CODIGO
               FIND EQ PLANO BY INDEX.1
               [~FOUND] CLEAR PLANO
               
               MOVEALL '' TO ST_COD_RECEITA ST_COD_PADRAO ST_COD_DEDUTORIA ST_COD_RECEITA_SIOPE
               MOVEALL '' TO ST_COD_RECEITA ST_TIPO_VALOR
               
               INDICATE DEVEDORA! AS PLANO.SALDO_DC EQ 'D'
               
               IF PARGERAL.EXERCICIO LE '2020' BEGIN
                                                     IF (MID(CONTACOR.CONTA,5,1)) EQ '5.2.1' MOVE '00' TO ST_TIPO_VALOR
                                                ELSE IF (MID(CONTACOR.CONTA,5,1)) EQ '6.2.1' MOVE '01' TO ST_TIPO_VALOR
                                         
                                                INDICATE RECEITA_DEDUTORIA! FALSE
                                                
                                                IF (((LEFT(PLANO.CODIGO,1)) EQ '5') AND (PLANO.SALDO_DC EQ 'C')) INDICATE RECEITA_DEDUTORIA! TRUE
                                                IF (((LEFT(PLANO.CODIGO,1)) EQ '6') AND (PLANO.SALDO_DC EQ 'D')) INDICATE RECEITA_DEDUTORIA! TRUE
                                                
                                                IF PLANO.CODIGO EQ '5.2.1.2.9.00.00.00' INDICATE RECEITA_DEDUTORIA! FALSE

                                                [~RECEITA_DEDUTORIA!] BEGIN
                                                                       [~@NOVO_CNR!] APPEND ST_COD_RECEITA (MID(CONTACOR.DADOS,16,20)) '0'
                                                                       [ @NOVO_CNR!] APPEND ST_COD_RECEITA (MID(CONTACOR.DADOS,14,20))
                                                                      END
                                                [ RECEITA_DEDUTORIA!] BEGIN
                                                                       [~@NOVO_CNR!] APPEND ST_COD_DEDUTORIA '9.1.1.' (MID(CONTACOR.DADOS,16,20)) '0'
                                                                       [ @NOVO_CNR!] APPEND ST_COD_DEDUTORIA '9.1.'   (MID(CONTACOR.DADOS,12,20))
                                                                                                                          
                                                                       CLEAR RELSIOP
                                                                       MOVE PARGERAL.ESTADO    TO RELSIOP.UF
                                                                       MOVE PARGERAL.EXERCICIO TO RELSIOP.ANO
                                                                       MOVE ST_SISTEMA         TO RELSIOP.SISTEMA
                                                                       MOVE 'RECEITA'          TO RELSIOP.NATUREZA
                                                                       MOVE ST_COD_DEDUTORIA   TO RELSIOP.CODIGO_TCE
                                                                       MOVE ''                 TO RELSIOP.CNR
                                                                       FIND EQ RELSIOP BY INDEX.2
                                                                       [~FOUND] BEGIN
                                                                                 [~@NOVO_CNR!] MOVE '9.1.1.0.00.00.000' TO ST_COD_DEDUTORIA
                                                                                 [ @NOVO_CNR!] MOVE '9.1.1.0.00.0.0'    TO ST_COD_DEDUTORIA
                                                                                END
                                                                      END
                                               END
               ELSE BEGIN
                     [~@NOVO_CNR!] APPEND ST_COD_RECEITA (MID(CONTACOR.DADOS,16,20)) '0'
                     [ @NOVO_CNR!] APPEND ST_COD_RECEITA (MID(CONTACOR.DADOS,14,20))
                     
                     IF (LEFT(CONTACOR.CONTA,7))  IN '5.2.1.1-5.2.1.2'                                             MOVE '00' TO ST_TIPO_VALOR //--previsao inicial e atualizada
                     IF (LEFT(CONTACOR.CONTA,7))  EQ '6.2.1.2'                                                     MOVE '01' TO ST_TIPO_VALOR //--arrecadacao
                     IF (LEFT(CONTACOR.CONTA,12)) EQ '6.2.1.3.1.01'                                                MOVE '02' TO ST_TIPO_VALOR //--arrecadacao deducao fundeb
                     IF (LEFT(CONTACOR.CONTA,9))  IN '6.2.1.3.2-6.2.1.3.3-6.2.1.3.4-6.2.1.3.5-6.2.1.3.6-6.2.1.3.9' MOVE '03' TO ST_TIPO_VALOR //--arrecadacao deducao outras
                     
                     IF (LEFT(ST_COD_RECEITA,1))  IN '7-8' IF ST_TIPO_VALOR NE '00'                                MOVE '04' TO ST_TIPO_VALOR //--intraorcamentaria
                    END
               
               MOVE ST_COD_RECEITA TO ST_COD_PADRAO
               BUSCA_CODIGO_SIOPE ST_COD_RECEITA ST_COD_PADRAO ST_COD_DEDUTORIA ST_COD_RECEITA_SIOPE
               
               //--grava linha analitica
               IF PARGERAL.EXERCICIO LE '2020' BEGIN
                                                [ DEVEDORA!] GRAVA_TEMPCALC ST_COD_RECEITA_SIOPE CONTACOR.CONTA ST_TIPO_VALOR (CONTACOR.VALOR_1 - CONTACOR.VALOR_2) 'SIOPE_REC'
                                                [~DEVEDORA!] GRAVA_TEMPCALC ST_COD_RECEITA_SIOPE CONTACOR.CONTA ST_TIPO_VALOR (CONTACOR.VALOR_2 - CONTACOR.VALOR_1) 'SIOPE_REC'
                                               END
               ELSE BEGIN
                     IF (LEFT(CONTACOR.CONTA,7))  IN '5.2.1.1-5.2.1.2' BEGIN
                                                                             IF CONTACOR.CONTA EQ '5.2.1.1.1.00.00.00' GRAVA_TEMPCALC ST_COD_RECEITA_SIOPE CONTACOR.CONTA ST_TIPO_VALOR (CONTACOR.VALOR_1 - CONTACOR.VALOR_2) 'SIOPE_REC'
                                                                        ELSE IF CONTACOR.CONTA EQ '5.2.1.2.1.01.00.00' GRAVA_TEMPCALC ST_COD_RECEITA_SIOPE CONTACOR.CONTA ST_TIPO_VALOR (CONTACOR.VALOR_1 - CONTACOR.VALOR_2) 'SIOPE_REC'
                                                                        ELSE IF CONTACOR.CONTA EQ '5.2.1.2.1.02.00.00' GRAVA_TEMPCALC ST_COD_RECEITA_SIOPE CONTACOR.CONTA ST_TIPO_VALOR (CONTACOR.VALOR_1 - CONTACOR.VALOR_2) 'SIOPE_REC'
                                                                        ELSE IF CONTACOR.CONTA EQ '5.2.1.2.9.00.00.00' GRAVA_TEMPCALC ST_COD_RECEITA_SIOPE CONTACOR.CONTA ST_TIPO_VALOR (CONTACOR.VALOR_1 - CONTACOR.VALOR_2) 'SIOPE_REC'
                                                                       END
                     ELSE BEGIN
                           [ DEVEDORA!] GRAVA_TEMPCALC ST_COD_RECEITA_SIOPE CONTACOR.CONTA ST_TIPO_VALOR (CONTACOR.VALOR_1 - CONTACOR.VALOR_2) 'SIOPE_REC'
                           [~DEVEDORA!] GRAVA_TEMPCALC ST_COD_RECEITA_SIOPE CONTACOR.CONTA ST_TIPO_VALOR (CONTACOR.VALOR_2 - CONTACOR.VALOR_1) 'SIOPE_REC'
                          END
                    END
                       
               CONSTRAINT_SET 1         
               CONSTRAINED_FIND NEXT
               END
             CONSTRAINT_SET 1 CLEAR
            LOOP 
           END  

//--
[ LE_MOV!] BEGIN
            CLEAR MOVREC
            CONSTRAINT_SET 1
            CONSTRAIN MOVREC.COD_ENTIDADE EQ ST@CODIGO@ENTIDADE
            CONSTRAIN MOVREC.EXERCICIO    EQ ST@EXERCICIO@FINANCEIRO
            CONSTRAIN MOVREC.TIPO         EQ 'A'
            CONSTRAINED_FIND FIRST MOVREC BY INDEX.1
            WHILE [FOUND]
             CALC (JN_LENDO + 1) TO JN_LENDO
             KEYCHECK GOSUB LB_ROTINA_PARADA
             
             MOVEALL  0 TO NB_ARRECADADO  NB_PREVISTO_ATUALIZADO
             
             MOVEALL '' TO ST_COD_RECEITA ST_COD_PADRAO ST_COD_DEDUTORIA ST_COD_RECEITA_SIOPE ST_TIPO_VALOR
             
             MOVE MOVREC.CODIGO                                                   TO ST_COD_RECEITA
             MOVE (OBTER_CODIGO_PADRAO_RECEITA(MOVREC.CODIGO,PARGERAL.EXERCICIO)) TO ST_COD_PADRAO
             
             INDICATE RECEITA_DEDUTORIA! AS (LEFT(MOVREC.CODIGO,1)) EQ '9'
             INDICATE    DEDUCAO_FUNDEB! AS (LEFT(MOVREC.CODIGO,3)) EQ '9.5'
             INDICATE    DEDUCAO_OUTRAS! AS (((LEFT(MOVREC.CODIGO,1)) EQ '9') AND ((LEFT(MOVREC.CODIGO,3)) NE '9.5'))
             
             [ RECEITA_DEDUTORIA!] BEGIN
                                    IF PARGERAL.EXERCICIO LE '2020' BEGIN
                                                                     IF (LEFT(MOVREC.CODIGO,5)) EQ '9.1.1' BEGIN
                                                                                                            [~@NOVO_CNR!] BEGIN
                                                                                                                           MOVE '9.1.1' TO ST_COD_DEDUTORIA
                                                                                                                           APPEND ST_COD_DEDUTORIA '.' (LEFT(MOVREC.COD_DIV_ATIVA,13)) '.000'
                                                                                                                          END
                                                                                                            [ @NOVO_CNR!] BEGIN 
                                                                                                                           MOVE '9.1' TO ST_COD_DEDUTORIA
                                                                                                                           APPEND ST_COD_DEDUTORIA '.' (LEFT(MOVREC.COD_DIV_ATIVA,12))
                                                                                                                          END
                                                                                                           END
                                                                     ELSE IF (LEFT(MOVREC.CODIGO,5)) EQ '9.5.1' BEGIN
                                                                                                                 [~@NOVO_CNR!] BEGIN
                                                                                                                                MOVE MOVREC.CODIGO TO ST_COD_DEDUTORIA
                                                                                                                               END
                                                                                                                 [ @NOVO_CNR!] BEGIN 
                                                                                                                                MOVE '9.5' TO ST_COD_DEDUTORIA
                                                                                                                                APPEND ST_COD_DEDUTORIA '.' (LEFT(MOVREC.COD_DIV_ATIVA,14))
                                                                                                                               END
                                                                                                                END
                                                                    END
                                    ELSE BEGIN
                                          MOVE MOVREC.COD_DIV_ATIVA                                                   TO ST_COD_RECEITA
                                          MOVE (OBTER_CODIGO_PADRAO_RECEITA(MOVREC.COD_DIV_ATIVA,PARGERAL.EXERCICIO)) TO ST_COD_PADRAO
                                         END
                                   END

             BUSCA_CODIGO_SIOPE ST_COD_RECEITA ST_COD_PADRAO ST_COD_DEDUTORIA ST_COD_RECEITA_SIOPE
             
             IF PARGERAL.EXERCICIO LE '2020' BEGIN
//                                               [ RECEITA_DEDUTORIA!] MOVE (MOVREC.VALOR_ORCADO * (-1)) TO NB_PREVISTO_ATUALIZADO
                                              [~RECEITA_DEDUTORIA!] MOVE  MOVREC.VALOR_ORCADO         TO NB_PREVISTO_ATUALIZADO
                                             END
             ELSE BEGIN
                   [~RECEITA_DEDUTORIA!] MOVE MOVREC.VALOR_ORCADO TO NB_PREVISTO_ATUALIZADO
                  END

             CLEAR ATUAREC
             CONSTRAINT_SET 2
             CONSTRAIN ATUAREC.COD_ENTIDADE EQ ST@CODIGO@ENTIDADE
             CONSTRAIN ATUAREC.EXERCICIO    EQ ST@EXERCICIO@FINANCEIRO
             CONSTRAIN ATUAREC.N_RECEITA    EQ MOVREC.NUMERO
             CONSTRAIN ATUAREC.DATA         LE DT_DATA_FINAL
             CONSTRAINED_FIND FIRST ATUAREC BY INDEX.1
             WHILE [FOUND]
              KEYCHECK GOSUB LB_ROTINA_PARADA
              CALC (JN_LENDO + 1) TO JN_LENDO

              IF PARGERAL.EXERCICIO LE '2020' BEGIN
//                                                [ RECEITA_DEDUTORIA!] CALC (NB_PREVISTO_ATUALIZADO + (ATUAREC.VALOR * (-1))) TO NB_PREVISTO_ATUALIZADO
                                               [~RECEITA_DEDUTORIA!] CALC (NB_PREVISTO_ATUALIZADO +  ATUAREC.VALOR)         TO NB_PREVISTO_ATUALIZADO
                                              END
              ELSE BEGIN
                    [~RECEITA_DEDUTORIA!] CALC (NB_PREVISTO_ATUALIZADO +  ATUAREC.VALOR) TO NB_PREVISTO_ATUALIZADO
                   END

              CONSTRAINT_SET 2
              CONSTRAINED_FIND NEXT
             END
             CONSTRAINT_SET 2 CLEAR
             
             //--previsao atualizada
             GRAVA_TEMPCALC ST_COD_RECEITA_SIOPE 'MOVREC' '00' NB_PREVISTO_ATUALIZADO 'SIOPE_REC'
             
             CLEAR MOVDREC
             CONSTRAINT_SET 3
             CONSTRAIN MOVDREC.COD_ENTIDADE EQ ST@CODIGO@ENTIDADE
             CONSTRAIN MOVDREC.EXERCICIO    EQ ST@EXERCICIO@FINANCEIRO
             CONSTRAIN MOVDREC.N_RECEITA    EQ MOVREC.NUMERO
             CONSTRAIN MOVDREC.DATA         LE DT_DATA_FINAL
             CONSTRAINED_FIND FIRST MOVDREC BY INDEX.2
             WHILE [FOUND]
              KEYCHECK GOSUB LB_ROTINA_PARADA
              CALC (JN_LENDO + 1) TO JN_LENDO

              [ RECEITA_DEDUTORIA!] CALC (NB_ARRECADADO + (MOVDREC.VALOR * (-1))) TO NB_ARRECADADO
              [~RECEITA_DEDUTORIA!] CALC (NB_ARRECADADO + MOVDREC.VALOR)          TO NB_ARRECADADO

              CONSTRAINT_SET 3
              CONSTRAINED_FIND NEXT
             END
             CONSTRAINT_SET 3 CLEAR
             
             //--arrecadado
             IF PARGERAL.EXERCICIO LE '2020' MOVE '01' TO ST_TIPO_VALOR
             ELSE BEGIN
                   [~RECEITA_DEDUTORIA!] BEGIN
                                          IF (LEFT(MOVREC.CODIGO,1)) IN '7-8' MOVE '04' TO ST_TIPO_VALOR
                                          ELSE                                MOVE '01' TO ST_TIPO_VALOR
                                         END
                   [    DEDUCAO_FUNDEB!] MOVE '02' TO ST_TIPO_VALOR
                   [    DEDUCAO_OUTRAS!] MOVE '03' TO ST_TIPO_VALOR
                  END
             
             GRAVA_TEMPCALC ST_COD_RECEITA_SIOPE 'MOVREC' ST_TIPO_VALOR NB_ARRECADADO 'SIOPE_REC'

             CONSTRAINT_SET 1         
             CONSTRAINED_FIND NEXT
            END
            CONSTRAINT_SET 1 CLEAR
           
            //--orcado proximo exercicio
            IF JN_MES EQ '12' BEGIN
                               MOVE 0 TO IT_VERSAO_LOA
                               CLEAR VERSAO
                               MOVE 'LOA'                    TO VERSAO.TIPO
                               MOVE 'A'                      TO VERSAO.ATIVO
                               MOVE (PARGERAL.EXERCICIO + 1) TO VERSAO.ANO_VIGENCIA_I
                               MOVE 2                        TO VERSAO.NUMERO
                               FIND EQ VERSAO BY INDEX.2
                               [ FOUND] BEGIN
                                         MOVE VERSAO.ID_VERSAO TO IT_VERSAO_LOA
                               
                                         CLEAR PLANREC
                                         CONSTRAINT_SET 1
                                         CONSTRAIN PLANREC.ID_VERSAO EQ IT_VERSAO_LOA
                                         [~TODAS!] CONSTRAIN PLANREC.COD_ENTIDADE EQ ST_ENTIDADE_SELECAO
                                         CONSTRAINED_FIND FIRST PLANREC BY INDEX.6
                                         WHILE [FOUND]
                                          CALC (JN_LENDO + 1) TO JN_LENDO
                                          KEYCHECK GOSUB LB_ROTINA_PARADA
                                          
                                          MOVEALL '' TO ST_COD_RECEITA ST_COD_PADRAO ST_COD_DEDUTORIA ST_COD_RECEITA_SIOPE ST_TIPO_VALOR
                                          
                                          MOVE PLANREC.CODIGO                                                   TO ST_COD_RECEITA
                                          MOVE (OBTER_CODIGO_PADRAO_RECEITA(PLANREC.CODIGO,PARGERAL.EXERCICIO)) TO ST_COD_PADRAO
                                          
                                          INDICATE RECEITA_DEDUTORIA! AS (LEFT(PLANREC.CODIGO,1)) EQ '9'
                                          
                                          [ RECEITA_DEDUTORIA!] BEGIN
                                                                 IF PARGERAL.EXERCICIO LE '2020' BEGIN
                                                                                                  IF (LEFT(PLANREC.CODIGO,5)) EQ '9.1.1' BEGIN
                                                                                                                                          [~@NOVO_CNR!] BEGIN
                                                                                                                                                         MOVE '9.1.1' TO ST_COD_DEDUTORIA
                                                                                                                                                         APPEND ST_COD_DEDUTORIA '.' (LEFT(PLANREC.COD_DIV_ATIVA,13)) '.000'
                                                                                                                                                        END
                                                                                                                                          [ @NOVO_CNR!] BEGIN 
                                                                                                                                                         MOVE '9.1' TO ST_COD_DEDUTORIA
                                                                                                                                                         APPEND ST_COD_DEDUTORIA '.' (LEFT(PLANREC.COD_DIV_ATIVA,12))
                                                                                                                                                        END
                                                                                                                                         END
                                                                                                  ELSE IF (LEFT(PLANREC.CODIGO,5)) EQ '9.5.1' BEGIN
                                                                                                                                               [~@NOVO_CNR!] BEGIN
                                                                                                                                                              MOVE PLANREC.CODIGO TO ST_COD_DEDUTORIA
                                                                                                                                                             END
                                                                                                                                               [ @NOVO_CNR!] BEGIN 
                                                                                                                                                              MOVE '9.5' TO ST_COD_DEDUTORIA
                                                                                                                                                              APPEND ST_COD_DEDUTORIA '.' (LEFT(PLANREC.COD_DIV_ATIVA,14))
                                                                                                                                                             END
                                                                                                                                              END
                                                                                                 END
                                                                 ELSE BEGIN
                                                                       MOVE PLANREC.COD_DIV_ATIVA                                                   TO ST_COD_RECEITA
                                                                       MOVE (OBTER_CODIGO_PADRAO_RECEITA(PLANREC.COD_DIV_ATIVA,PARGERAL.EXERCICIO)) TO ST_COD_PADRAO
                                                                      END
                                                                END
                                          
                                          IF PARGERAL.EXERCICIO LE '2020' MOVE '02' TO ST_TIPO_VALOR
                                          ELSE                            MOVE '05' TO ST_TIPO_VALOR
                                          
                                          BUSCA_CODIGO_SIOPE ST_COD_RECEITA ST_COD_PADRAO ST_COD_DEDUTORIA ST_COD_RECEITA_SIOPE
                                          
                                          //--grava linha analitica
                                          IF PARGERAL.EXERCICIO LE '2020' BEGIN
                                                                           [~RECEITA_DEDUTORIA!] GRAVA_TEMPCALC ST_COD_RECEITA_SIOPE 'PLANREC' ST_TIPO_VALOR PLANREC.VALOR_ORCADO          'SIOPE_REC'
                                                                           [ RECEITA_DEDUTORIA!] GRAVA_TEMPCALC ST_COD_RECEITA_SIOPE 'PLANREC' ST_TIPO_VALOR (PLANREC.VALOR_ORCADO * (-1)) 'SIOPE_REC'
                                                                          END
                                          ELSE BEGIN
                                                GRAVA_TEMPCALC ST_COD_RECEITA_SIOPE 'PLANREC' ST_TIPO_VALOR PLANREC.VALOR_ORCADO 'SIOPE_REC'
                                               END
                                          
                                          CONSTRAINT_SET 1
                                          CONSTRAINED_FIND NEXT
                                          END
                                         CONSTRAINT_SET 1 CLEAR
                                        END
                              END
           END

//--cria todas as numeracoes das colunas pra cada CNR
IF PARGERAL.EXERCICIO LE '2020' MOVE 2 TO IT_MAXIMO_COLUNA
ELSE BEGIN
      IF JN_MES LE '11' MOVE 4 TO IT_MAXIMO_COLUNA
      ELSE              MOVE 5 TO IT_MAXIMO_COLUNA
     END

CLEAR CADSIOP
CONSTRAINT_SET 1
CONSTRAIN CADSIOP.SISTEMA  EQ 'SIOPE'
CONSTRAIN CADSIOP.ANO      EQ PARGERAL.EXERCICIO
CONSTRAIN CADSIOP.NATUREZA EQ 'RECEITA'
CONSTRAINED_FIND FIRST CADSIOP BY INDEX.1
WHILE [FOUND]
 CALC (JN_LENDO + 1) TO JN_LENDO
 
 CLEAR TEMPCALC
 MOVE ST@CODIGO@ENTIDADE      TO TEMPCALC.COD_ENTIDADE
 MOVE ST@EXERCICIO@FINANCEIRO TO TEMPCALC.EXERCICIO
 MOVE ST@USUARIO              TO TEMPCALC.USUARIO
 MOVE CADSIOP.CODIGO          TO TEMPCALC.CODIGO
 FIND GT TEMPCALC BY INDEX.1
 [ FOUND] INDICATE FOUND AS TEMPCALC.COD_ENTIDADE EQ ST@CODIGO@ENTIDADE
 [ FOUND] INDICATE FOUND AS TEMPCALC.EXERCICIO    EQ ST@EXERCICIO@FINANCEIRO
 [ FOUND] INDICATE FOUND AS TEMPCALC.USUARIO      EQ ST@USUARIO
 [ FOUND] INDICATE FOUND AS TEMPCALC.CODIGO       EQ CADSIOP.CODIGO
 [ FOUND] BEGIN
           
           MOVE 0 TO IT_AUX
           FOR IT_AUX FROM 0 TO IT_MAXIMO_COLUNA
            MOVE IT_AUX TO ST_AUX
            COMZEROS ST_AUX 2
            
            CLEAR TEMPCALC
            MOVE ST@CODIGO@ENTIDADE      TO TEMPCALC.COD_ENTIDADE
            MOVE ST@EXERCICIO@FINANCEIRO TO TEMPCALC.EXERCICIO
            MOVE ST@USUARIO              TO TEMPCALC.USUARIO
            MOVE CADSIOP.CODIGO          TO TEMPCALC.CODIGO
            MOVE ST_AUX                  TO TEMPCALC.NUMERO
            FIND EQ TEMPCALC BY INDEX.1
            INDICATE ERR FALSE
            ON ERROR GOSUB CHECA_GRAVACAO
            [ FOUND] REREAD TEMPCALC
            MOVE 'SIOPE_REC' TO TEMPCALC.AUXILIAR
            SAVERECORD TEMPCALC
            UNLOCK
            ON ERROR OFF
           LOOP
          END
 
 CONSTRAINT_SET 1
 CONSTRAINED_FIND NEXT
 END
CONSTRAINT_SET 1 CLEAR

//--geracao do arquivo texto
DIRECT_OUTPUT ST_ARQUIVO

MOVE 'V;1;1' TO ST_AUX

CLEAR CADSIOP
CONSTRAINT_SET 1
CONSTRAIN CADSIOP.SISTEMA  EQ 'SIOPE'
CONSTRAIN CADSIOP.ANO      EQ PARGERAL.EXERCICIO
CONSTRAIN CADSIOP.NATUREZA EQ 'RECEITA'
CONSTRAINED_FIND FIRST CADSIOP BY INDEX.1
WHILE [FOUND]
 CALC (JN_LENDO + 1) TO JN_LENDO
 
 INDICATE IMPRIME! FALSE
 
 CLEAR TEMPCALC
 CONSTRAINT_SET 2
 CONSTRAIN TEMPCALC.COD_ENTIDADE EQ ST@CODIGO@ENTIDADE
 CONSTRAIN TEMPCALC.EXERCICIO    EQ ST@EXERCICIO@FINANCEIRO
 CONSTRAIN TEMPCALC.USUARIO      EQ ST@USUARIO
 CONSTRAIN TEMPCALC.CODIGO       EQ CADSIOP.CODIGO
 CONSTRAIN TEMPCALC.AUXILIAR     EQ 'SIOPE_REC'
 CONSTRAINED_FIND FIRST TEMPCALC BY INDEX.1
 WHILE [FOUND]
  CALC (JN_LENDO + 1) TO JN_LENDO
  
  [~IMPRIME!] WRITE ST_AUX ';' (TRIM(TEMPCALC.CODIGO)) ';' (TRIM(CADSIOP.DESCRICAO))
  
  WRITE ';' TEMPCALC.VALOR
  
  INDICATE IMPRIME! TRUE
  
  CONSTRAINT_SET 2 
  CONSTRAINED_FIND NEXT
  END
 CONSTRAINT_SET 2 CLEAR
  
 [ IMPRIME!] WRITELN
 
 CONSTRAINT_SET 1
 CONSTRAINED_FIND NEXT
 END
CONSTRAINT_SET 1 CLEAR
 
CLOSE_OUTPUT ST_ARQUIVO
APAGA_TEMPCALC
ABORT

LB_VERIFICACAO:
 ABREREL_GERRELAT 'INCONSIST┬NCIAS P/ GERA─▌O DO SIOPE - RECEITA' '132C+' 'T' 

 MOVE 1 TO PAGECOUNT
 MOVE 0 TO RECCOUNT

 CABEC ST@PREFEITURA JHD_PREFEITURA
 SYSDATA             JHD_DATA
 PRINT PAGECOUNT  TO JHD_PAGINA
 CABEC ST_PERIODO    JHD_PERIODO
 OUTPUT HEADER

 SCREENMODE IT_COR_TARJA ON
 PAGE MSG

 [ LE_XML!] BEGIN
             MOVE JN_MES TO IT_MES_FINAL

             FOR IT_MES FROM 1 TO IT_MES_FINAL
              MOVE IT_MES TO ST_MES_BUSCA
              COMZEROS ST_MES_BUSCA 2

              CLEAR CONTACOR
              CONSTRAINT_SET 1
              CONSTRAIN CONTACOR.ANO                    EQ ST_EXERCICIO
              CONSTRAIN CONTACOR.MES                    EQ ST_MES_BUSCA
              [~TCEMG!] CONSTRAIN CONTACOR.XML          EQ '06'
              [ TCEMG!] CONSTRAIN CONTACOR.XML          EQ '12'
              [~TODAS!] CONSTRAIN CONTACOR.COD_ENTIDADE EQ ST_ENTIDADE_SELECAO
              [~TUDO_XML!] CONSTRAIN CONTACOR.COD_ENTIDADE NE ST_PROPRIA_ENTIDADE
              CONSTRAINED_FIND FIRST CONTACOR BY INDEX.3
              WHILE [FOUND]
               CALC (JN_LENDO + 1) TO JN_LENDO
               KEYCHECK GOSUB LB_ROTINA_PARADA

               MOVEALL '' TO ST_COD_RECEITA ST_COD_PADRAO ST_COD_DEDUTORIA ST_COD_RECEITA_SIOPE
               
               INDICATE DEVEDORA! AS PLANO.SALDO_DC EQ 'D'
               
               INDICATE RECEITA_DEDUTORIA! FALSE
               
               IF (((LEFT(PLANO.CODIGO,1)) EQ '5') AND (PLANO.SALDO_DC EQ 'C')) INDICATE RECEITA_DEDUTORIA! TRUE
               IF (((LEFT(PLANO.CODIGO,1)) EQ '6') AND (PLANO.SALDO_DC EQ 'D')) INDICATE RECEITA_DEDUTORIA! TRUE
               
               IF PLANO.CODIGO EQ '5.2.1.2.9.00.00.00' INDICATE RECEITA_DEDUTORIA! FALSE
               
               IF PARGERAL.EXERCICIO LE '2020' BEGIN
                                                [~RECEITA_DEDUTORIA!] BEGIN
                                                                       [~@NOVO_CNR!] APPEND ST_COD_RECEITA (MID(CONTACOR.DADOS,16,20)) '0'
                                                                       [ @NOVO_CNR!] APPEND ST_COD_RECEITA (MID(CONTACOR.DADOS,14,20))
                                                                      END
                                                [ RECEITA_DEDUTORIA!] BEGIN
                                                                       [~@NOVO_CNR!] APPEND ST_COD_DEDUTORIA '9.1.1.' (MID(CONTACOR.DADOS,16,20)) '0'
                                                                       [ @NOVO_CNR!] APPEND ST_COD_DEDUTORIA '9.1.'   (MID(CONTACOR.DADOS,12,20))
                                                                                                                          
                                                                       CLEAR RELSIOP
                                                                       MOVE PARGERAL.ESTADO    TO RELSIOP.UF
                                                                       MOVE PARGERAL.EXERCICIO TO RELSIOP.ANO
                                                                       MOVE ST_SISTEMA         TO RELSIOP.SISTEMA
                                                                       MOVE 'RECEITA'          TO RELSIOP.NATUREZA
                                                                       MOVE ST_COD_DEDUTORIA   TO RELSIOP.CODIGO_TCE
                                                                       MOVE ''                 TO RELSIOP.CNR
                                                                       FIND EQ RELSIOP BY INDEX.2
                                                                       [~FOUND] BEGIN
                                                                                 [~@NOVO_CNR!] MOVE '9.1.1.0.00.00.000' TO ST_COD_DEDUTORIA
                                                                                 [ @NOVO_CNR!] MOVE '9.1.1.0.00.0.0'    TO ST_COD_DEDUTORIA
                                                                                END
                                                                      END
                                               END
               ELSE BEGIN
                     [~@NOVO_CNR!] APPEND ST_COD_RECEITA (MID(CONTACOR.DADOS,16,20)) '0'
                     [ @NOVO_CNR!] APPEND ST_COD_RECEITA (MID(CONTACOR.DADOS,14,20))
                    END
                                       
               MOVE ST_COD_RECEITA TO ST_COD_PADRAO
               
               BUSCA_CODIGO_SIOPE ST_COD_RECEITA ST_COD_PADRAO ST_COD_DEDUTORIA ST_COD_RECEITA_SIOPE
               
               IF ST_COD_RECEITA_SIOPE EQ '' BEGIN
                                              INCREMENT RECCOUNT
                                            
                                              MOVE 'COD. RECEITA ' TO ST_BODY
                                                   IF ST_COD_RECEITA   NE '' APPEND ST_BODY ' ' ST_COD_RECEITA ' SEM RELACIONAMENTO COM O PLANO DE RECEITAS DO SIOPE'
                                              ELSE IF ST_COD_DEDUTORIA NE '' APPEND ST_BODY ' ' ST_COD_DEDUTORIA ' SEM RELACIONAMENTO COM O PLANO DE RECEITAS DO SIOPE'
                                              PRINT ST_BODY TO JBD_DESCRICAO
                                              OUTPUT BODY
                                              GOSUB LB_PULA_PAGINA
                                             END
               ELSE BEGIN
                     //--verifica cadastro do siope
                     CLEAR CADSIOP
                     MOVE ST_SISTEMA           TO CADSIOP.SISTEMA
                     MOVE ST_EXERCICIO         TO CADSIOP.ANO
                     MOVE 'RECEITA'            TO CADSIOP.NATUREZA
                     MOVE ST_COD_RECEITA_SIOPE TO CADSIOP.CODIGO
                     FIND EQ CADSIOP BY INDEX.1
                     [~FOUND] BEGIN
                               INCREMENT RECCOUNT
                             
                               MOVE 'COD. RECEITA ' TO ST_BODY
                               APPEND ST_BODY ' ' ST_COD_RECEITA_SIOPE ' INEXISTENTE NO CADASTRO DE RECEITAS DO SIOPE'
                               PRINT ST_BODY TO JBD_DESCRICAO
                               OUTPUT BODY
                               GOSUB LB_PULA_PAGINA
                              END
                    END
                       
               CONSTRAINT_SET 1         
               CONSTRAINED_FIND NEXT
               END
              CONSTRAINT_SET 1 CLEAR
             LOOP 
            END  

 //--
 [ LE_MOV!] BEGIN
             CLEAR MOVREC
             CONSTRAINT_SET 1
             CONSTRAIN MOVREC.COD_ENTIDADE EQ ST@CODIGO@ENTIDADE
             CONSTRAIN MOVREC.EXERCICIO    EQ ST@EXERCICIO@FINANCEIRO
             CONSTRAIN MOVREC.TIPO         EQ 'A'
             CONSTRAINED_FIND FIRST MOVREC BY INDEX.1
             WHILE [FOUND]
              CALC (JN_LENDO + 1) TO JN_LENDO
              KEYCHECK GOSUB LB_ROTINA_PARADA

              MOVEALL '' TO ST_COD_RECEITA ST_COD_PADRAO ST_COD_DEDUTORIA ST_COD_RECEITA_SIOPE
              
              MOVE MOVREC.CODIGO                                                   TO ST_COD_RECEITA
              MOVE (OBTER_CODIGO_PADRAO_RECEITA(MOVREC.CODIGO,PARGERAL.EXERCICIO)) TO ST_COD_PADRAO
              
              INDICATE RECEITA_DEDUTORIA! AS (LEFT(MOVREC.CODIGO,1)) EQ '9'
              
              [ RECEITA_DEDUTORIA!] BEGIN
                                     IF PARGERAL.EXERCICIO LE '2020' BEGIN
                                                                      IF (LEFT(MOVREC.CODIGO,5)) EQ '9.1.1' BEGIN
                                                                                                             [~@NOVO_CNR!] BEGIN
                                                                                                                            MOVE '9.1.1' TO ST_COD_DEDUTORIA
                                                                                                                            APPEND ST_COD_DEDUTORIA '.' (LEFT(MOVREC.COD_DIV_ATIVA,13)) '.000'
                                                                                                                           END
                                                                                                             [ @NOVO_CNR!] BEGIN 
                                                                                                                            MOVE '9.1' TO ST_COD_DEDUTORIA
                                                                                                                            APPEND ST_COD_DEDUTORIA '.' (LEFT(MOVREC.COD_DIV_ATIVA,12))
                                                                                                                           END
                                                                                                            END
                                                                      ELSE IF (LEFT(MOVREC.CODIGO,5)) EQ '9.5.1' BEGIN
                                                                                                                  [~@NOVO_CNR!] BEGIN
                                                                                                                                 MOVE MOVREC.CODIGO TO ST_COD_DEDUTORIA
                                                                                                                                END
                                                                                                                  [ @NOVO_CNR!] BEGIN 
                                                                                                                                 MOVE '9.5' TO ST_COD_DEDUTORIA
                                                                                                                                 APPEND ST_COD_DEDUTORIA '.' (LEFT(MOVREC.COD_DIV_ATIVA,14))
                                                                                                                                END
                                                                                                                 END
                                                                     END
                                     ELSE BEGIN
                                           MOVE MOVREC.COD_DIV_ATIVA                                                   TO ST_COD_RECEITA
                                           MOVE (OBTER_CODIGO_PADRAO_RECEITA(MOVREC.COD_DIV_ATIVA,PARGERAL.EXERCICIO)) TO ST_COD_PADRAO
                                          END
                                    END
              
              BUSCA_CODIGO_SIOPE ST_COD_RECEITA ST_COD_PADRAO ST_COD_DEDUTORIA ST_COD_RECEITA_SIOPE
              
              IF ST_COD_RECEITA_SIOPE EQ '' BEGIN
                                             INCREMENT RECCOUNT
                                             
                                             MOVE 'COD. RECEITA ' TO ST_BODY
                                             APPEND ST_BODY ' ' MOVREC.CODIGO ' SEM RELACIONAMENTO COM O PLANO DE RECEITAS DO SIOPE'
                                             PRINT ST_BODY TO JBD_DESCRICAO
                                             OUTPUT BODY
                                             GOSUB LB_PULA_PAGINA
                                            END
              ELSE BEGIN
                    //--verifica cadastro do siope
                    CLEAR CADSIOP
                    MOVE ST_SISTEMA           TO CADSIOP.SISTEMA
                    MOVE ST_EXERCICIO         TO CADSIOP.ANO
                    MOVE 'RECEITA'            TO CADSIOP.NATUREZA
                    MOVE ST_COD_RECEITA_SIOPE TO CADSIOP.CODIGO
                    FIND EQ CADSIOP BY INDEX.1
                    [~FOUND] BEGIN
                              INCREMENT RECCOUNT
                            
                              MOVE 'COD. RECEITA ' TO ST_BODY
                              APPEND ST_BODY ' ' ST_COD_RECEITA_SIOPE ' INEXISTENTE NO CADASTRO DE RECEITAS DO SIOPE'
                              PRINT ST_BODY TO JBD_DESCRICAO
                              OUTPUT BODY
                              GOSUB LB_PULA_PAGINA
                             END
                   END
              
              CONSTRAINT_SET 1
              CONSTRAINED_FIND NEXT
              END
             CONSTRAINT_SET 1 CLEAR
            END
 
 OUTPUT TOTAL
 BUSCA_CAMINHO_MENU 'RSIOPE01' ''
 FORMFEED
 GRAVAPAG 'C'

 IF RECCOUNT NE 0 BEGIN
  ADVERTE 'VERIFIQUE RELAT╒RIO DE INCONSIST┬NCIAS DO SIOPE - RECEITA'
  //ABORT
  END
RETURN

//-----------------------------------------------------------

LB_ROTINA_PARADA:
 CABEC 'GOSTARIA REALMENTE DE SAIR < S/N >?' CONFIRMA.1
 PAGE CONFIRMA
 INKEYCHECK ST_TECLA IN 'SsNn'
 IF ST_TECLA IN 'Ss' BEGIN
                      MOVE 0 TO RECCOUNT
                      LIMPA_PRN
                     END
 
 MOVE 0 TO CURRENT_IMAGE
 PAGE TELA
 PAGE MSG
RETURN

LB_PULA_PAGINA:
 IF LINECOUNT GE 58 BEGIN
  OUTPUT TOTAL
  FORMFEED
  PRINT PAGECOUNT TO JHD_PAGINA
  OUTPUT HEADER
  END
RETURN

KEYPROC KEY.UP
 IF CURRENT_WINDOW EQ 3 BEGIN
                         [ PREFE!] BACKFIELD
                         [~PREFE!] RETURN LB_MES
                        END
 ELSE BACKFIELD
RETURN

KEYPROC KEY.FIELD
 IF CURRENT_WINDOW EQ 1 BEGIN
                         MOVE 'CENTIDAD 1 ' TO ST_JUNTA
                         APPEND ST_JUNTA ST@USUARIO ' ' ST@OPCAO ' ' ST@PROGRAMA ' ' ST@CODIGO@ENTIDADE ' ' ST@EXERCICIO@FINANCEIRO
                         CHAIN WAIT ST_JUNTA EXPORT_FILES
                         MOVE 0 TO CURRENT_IMAGE
                         PAGE TELA
                         IF ENTIDADE.CODIGO NE "" BEGIN
                                                   TRIM ENTIDADE.CODIGO    TO JN_COD_ENTIDADE
                                                   TRIM ENTIDADE.DESCRICAO TO JN_ENTIDADE
                                                  END
                         ELSE ENTAGAIN
                         RETURN
                        END
 ENTAGAIN
RETURN


#INCLUDE INTEGRID.INC

