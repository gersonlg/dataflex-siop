/TELA RESIDENT
фмммммммммммммммммммммммммммммммммммммммммммммммммммммммммммммммммммммммммммммм╣
Ё                                                                              Ё
Ё                                                                              Ё
цдддддддддд GERACAO DE ARQUIVO PARA IMPORTACAO DO SIOPS - RECEITA ддддддддддддд╢
Ё                                                                              Ё
Ё                                                                              Ё
Ё                                                                              Ё
Ё                                                                              Ё
Ё  Entidade <F2>   : __ _____________________________________________________  Ё
Ё                                                                              Ё
Ё                                                                              Ё
Ё  Mes             : __                                                        Ё
Ё                                                                              Ё
Ё                                                                              Ё
Ё                                                                              Ё
Ё                                                                              Ё
Ё                                                                              Ё
цдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
Ё                               <ESC>  Retorna                                 Ё
юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
/CONFIRMA RESIDENT
цдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
Ё______________________________________________________________________________Ё
юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
/MSG RESIDENT
зддддддддд GERACAO DE ARQUIVO PARA IMPORTACAO DO SIOPS - RECEITA дддддддддддд©
Ё                                                                            Ё
цдддддддддддддддддддддддддддддд SOLICITADO дддддддддддддддддддддддддддддддддд╢
Ё                                                                            Ё
Ё                                                                            Ё
Ё                            Receitas - Siops                                Ё
Ё                                                                            Ё
Ё                                                                            Ё
цдддддддддддддддддддддддддддддд PROCESSANDO ддддддддддддддддддддддддддддддддд╢
Ё                                                                            Ё
Ё                                                                            Ё
Ё                       Ч Gerando Arquivos Textos Ч                          Ё
Ё                                                                            Ё
Ё                                                                            Ё
Ё                           Lendo :  __________.                             Ё
Ё                                                                            Ё
юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
/HEADER RESIDENT
 -----------------------------------------------------------------------------------------------------------------
|                                                                                                                 |
|                          ___________________________________________________________                            |
|                                                                                                                 |
|                                                                                                                 |
|                   PENDENCIAS REFERENTE A GERACAO DE ARQUIVO TEXTO PARA O SIOPS - RECEITAS                       |
|                                                                                                                 |
|                          ___________________________________________________________                            |
| __/__/____                                                                                         Pagina ____. |
|-----------------------------------------------------------------------------------------------------------------|
/BODY RESIDENT
| _______________________________________________________________________________________________________________ |
/TOTAL RESIDENT
 -----------------------------------------------------------------------------------------------------------------
/VALOR# RESIDENT
______________.__
/FANTASMA# RESIDENT
_________________
/*
#INCLUDE CONAM.LIB
#INCLUDE ZERAARQ.LIB
#INCLUDE CAMINHO.LIB

//--!1 codigo do cliente
//--!2 codigo padrao tce
//--!3 variavel para receber o codigo siops
//--
#COMMAND BUSCA_CODIGO_SIOPS
#IFDEF ST@COD@REC@AUX
#ELSE
 STRING ST@COD@REC@AUX
#ENDIF
#IFDEF ST@COD@REC@ACHADO
#ELSE
 STRING ST@COD@REC@ACHADO
#ENDIF
#IFDEF ST@CODIGO@BUSCA
#ELSE
 STRING ST@CODIGO@BUSCA
#ENDIF
 
 MOVEALL '' TO ST@COD@REC@AUX ST@COD@REC@ACHADO !3
 
 IF ST@EXERCICIO@FINANCEIRO LE '2024' BEGIN
                                       [~@NOVO_CNR!] MOVE      !2        TO ST@COD@REC@AUX
                                       [ @NOVO_CNR!] MOVE (MID(!2,14,1)) TO ST@COD@REC@AUX
                                       MOVE !1                           TO ST@CODIGO@BUSCA
                                      END
 ELSE BEGIN
       MOVE (MID(!1,14,1)) TO ST@CODIGO@BUSCA
      END

 // clearxy 0 0
 // showln ST_COD_RECEITA
 // showln ST_COD_PADRAO
 // showln ST@CODIGO@BUSCA
 // if !1 eq '7.6.1.1.50.1.1.0000'               pause .
 //  KEYCHECK abort
 
 //--busca pelo codigo analitico do cliente
 CLEAR RELSIOP
 MOVE PARGERAL.ESTADO    TO RELSIOP.UF
 MOVE PARGERAL.EXERCICIO TO RELSIOP.ANO
 MOVE 'SIOPS'            TO RELSIOP.SISTEMA
 MOVE 'RECEITA'          TO RELSIOP.NATUREZA
 MOVE ST@CODIGO@BUSCA    TO RELSIOP.CODIGO_TCE
 MOVE ''                 TO RELSIOP.CNR
 FIND EQ RELSIOP BY INDEX.2
 [ FOUND] MOVE RELSIOP.CODIGO_SIOP TO ST@COD@REC@ACHADO
 [~FOUND] BEGIN
           
           
           CLEAR RELSIOP
           MOVE PARGERAL.ESTADO    TO RELSIOP.UF
           MOVE PARGERAL.EXERCICIO TO RELSIOP.ANO
           MOVE 'SIOPS'            TO RELSIOP.SISTEMA
           MOVE 'RECEITA'          TO RELSIOP.NATUREZA
           MOVE ST@COD@REC@AUX     TO RELSIOP.CODIGO_TCE
           MOVE ''                 TO RELSIOP.CNR
           FIND EQ RELSIOP BY INDEX.2
           [ FOUND] MOVE RELSIOP.CODIGO_SIOP TO ST@COD@REC@ACHADO
          END
 
 IF ST@COD@REC@ACHADO NE '' MOVE ST@COD@REC@ACHADO TO !3
#ENDCOMMAND

STRING  ST_PROPRIA_ENTIDADE ST_ARQUIVO 255  ST_AUX        255 ST_DIRETORIO   255 ST_EXERCICIO     ST_HORA             ST_COD_RECEITA_SIOPS
STRING  ST_MES              ST_MINUTO       ST_NOME_MES       ST_PERIODO         ST_SEGUNDO       ST_ENTIDADE_SELECAO ST_COD_APLICACAO
STRING  ST@NUMERO           ST@JUNCAO       ST@PAGINAS        ST_JUNTA       255 ST_JUNTANDO      ST_DATA             ST_ENTIDADE_SAUDE
STRING  ST_MES_BUSCA        ST_COD_RECEITA  ST_BIMESTRE       ST_BODY        255 ST_ENTIDADE_RPPS ST_COD_PADRAO       ST_VALOR
STRING  ST_FONTE_RECURSO    ST_NATUREZA     ST_SAIDA      255

DATE    DT_DATA DT_DATA_FINAL DT_DATA_INICIO_ANO

INTEGER RECCOUNT IT@NUMERO IT_MES IT_MES_FINAL IT_AUX IT_ORDEM IT_POS IT_GRAU IT_VERSAO_LOA

NUMBER  NB_ARRECADADO NB_PREVISTO_ATUALIZADO NB_PREVISTO_INICIAL NB_ARRECADADO_DEDUCAO NB_ARRECADADO_FUNDEB NB_REALIZADA_BASE NB_TOTAL_LIQUIDO NB_VALOR NB_AUX

AUTOPAGE MSG
NAME JN_LENDO

AUTOPAGE HEADER
NAME JHD_PREFEITURA
NAME JHD_PERIODO
NAME JHD_DATA       JHD_PAGINA

AUTOPAGE BODY
NAME JBD_DESCRICAO

AUTOPAGE TELA
NAME JN_COD_ENTIDADE  JN_ENTIDADE
NAME JN_MES

PAGE SET TELA     AT  4  0 COLORS IT_COR_TARJA  IT_COR_MOLDURA
PAGE SET MSG      AT 05 01 COLORS IT_COR_TITULO IT_COR_TITULO
PAGE SET CONFIRMA AT 21 00 COLORS IT_COR_TARJA  IT_COR_MOLDURA

OPEN ARQ_PRN
OPEN ENTIDADE
OPEN TEMPCALC
OPEN RECEITAS
OPEN PLANO
OPEN MOVREC
OPEN MOVDREC
OPEN ATUAREC
OPEN VERSAO
OPEN PLANREC
OPEN FONTREC
OPEN MRECFONT
OPEN RECEITAS
OPEN FUNDOS
OPEN RELSIOP
OPEN CADSIOP
OPEN IBGE
ABRE_CONTACOR ST@EXERCICIO@FINANCEIRO CONTACOR


IF PARGERAL.COD_ENTIDADE NE '01' BEGIN
                                  ADVERTE 'PROGRAMA INDISPONIVEL PARA ESSA ENTIDADE'
                                  ABORT
                                 END
            
MOVE PARGERAL.COD_ENTIDADE TO ST_PROPRIA_ENTIDADE

DEFINE_CODIGO_RECEITA PARGERAL.EXERCICIO

INDICATE TCEMG! AS PARGERAL.ESTADO       EQ 'MG'
INDICATE PREFE! AS PARGERAL.COD_ENTIDADE EQ '01'

CLEAR ENTIDADE
MOVE ST@EXERCICIO@FINANCEIRO TO ENTIDADE.EXERCICIO 
REPEAT
 FIND GT ENTIDADE BY INDEX.1
 [ FOUND] INDICATE FOUND AS ENTIDADE.EXERCICIO EQ ST@EXERCICIO@FINANCEIRO
 [ FOUND] BEGIN
           IF ENTIDADE.TP_ENTIDADE EQ '1' MOVE ENTIDADE.CODIGO TO ST_ENTIDADE_RPPS
           IF ENTIDADE.TP_ENTIDADE EQ '2' MOVE ENTIDADE.CODIGO TO ST_ENTIDADE_SAUDE
          END
UNTIL [~FOUND]

[~PREFE!] IF PARGERAL.COD_ENTIDADE NE ST_ENTIDADE_SAUDE BEGIN
                                                         ADVERTE 'OPCAO DESABILITADA PARA ESSA ENTIDADE'
                                                         ABORT
                                                        END

[ PREFE!] BEGIN
           ADVERTE 'CERTIFIQUE-SE SE OS DADOS DAS DEMAIS ENTIDADES DO MUNICIPIO FORAM IMPORTADOS, PARA A CORRETA ALIMENTACAO DO SIOPS.'
          END

INICIO:
SCREENMODE IT_COR_TARJA ON
PAGE TELA

[ PREFE!] BEGIN
           ACCEPT JN_COD_ENTIDADE {AUTOCLEAR}
           [KEY.ESCAPE] ABORT
           IF JN_COD_ENTIDADE NE '' BEGIN
                                     COMZEROS JN_COD_ENTIDADE 2
                                     CLEAR ENTIDADE
                                     MOVE ST@EXERCICIO@FINANCEIRO TO ENTIDADE.EXERCICIO 
                                     MOVE JN_COD_ENTIDADE         TO ENTIDADE.CODIGO
                                     FIND EQ ENTIDADE BY INDEX.1
                                     [~FOUND] BEGIN
                                               ADVERTE 'ENTIDADE N▌O CADASTRADA'
                                               GOTO INICIO
                                              END
                                     MOVE ENTIDADE.DESCRICAO TO JN_ENTIDADE
                                    END
           ELSE MOVE 'CONSOLIDADO' TO JN_ENTIDADE
          END
[~PREFE!] BEGIN
           MOVE PARGERAL.COD_ENTIDADE TO JN_COD_ENTIDADE
           
           CLEAR ENTIDADE
           MOVE ST@EXERCICIO@FINANCEIRO TO ENTIDADE.EXERCICIO 
           MOVE JN_COD_ENTIDADE         TO ENTIDADE.CODIGO
           FIND EQ ENTIDADE BY INDEX.1
           MOVE ENTIDADE.DESCRICAO TO JN_ENTIDADE
          END

IF JN_COD_ENTIDADE EQ '02' BEGIN
                            ADVERTE 'ENTIDADE SELECIONADA INVALIDA'
                            GOTO INICIO
                           END

INDICATE TODAS! AS JN_COD_ENTIDADE EQ ''
MOVE JN_COD_ENTIDADE TO ST_ENTIDADE_SELECAO

LB_MES:
REPEAT
 ACCEPT JN_MES
 [KEY.ESCAPE] ABORT
 COMZEROS JN_MES 2
 IF NOT JN_MES IN '02a04a06a08a10a12' BEGIN
                                       MENSAGEM 353
                                       CLEARFORM JN_MES
                                      END
UNTIL JN_MES NE ''

INDICATE LE_MOV! AS ((JN_COD_ENTIDADE       LE '01')  OR (PARGERAL.COD_ENTIDADE GT '01')) //--ler movimento da propria entidade
INDICATE LE_XML! AS ((PARGERAL.COD_ENTIDADE EQ '01') AND (ST_ENTIDADE_SELECAO   NE '01')) //--ler movimento de outra entidade

IF (OBTER_CONFIGURACAO('SIOPS_DADOS_XML',ST@CODIGO@ENTIDADE,ST@EXERCICIO@FINANCEIRO)) NE '' BEGIN
 INDICATE LE_MOV! FALSE
 INDICATE LE_XML! TRUE
END

MOVE JN_MES             TO ST_MES
MOVE PARGERAL.EXERCICIO TO ST_JUNTANDO
MOVE PARGERAL.EXERCICIO TO ST_EXERCICIO

MOVEALL '' TO ST_NOME_MES ST_AUX
APPEND ST_NOME_MES 'JANEIRO A '
MONTH JN_MES ST_AUX
APPEND ST_NOME_MES ST_AUX ST_JUNTANDO

MOVE '01/01/' TO ST_DATA
APPEND ST_DATA PARGERAL.EXERCICIO
MOVE ST_DATA  TO DT_DATA_INICIO_ANO

MOVE '01/'    TO ST_DATA
IF ST_MES LT '12' APPEND ST_DATA (ST_MES + 1) '/' PARGERAL.EXERCICIO
IF ST_MES EQ '12' APPEND ST_DATA  '01' '/' (PARGERAL.EXERCICIO + 1)
MOVE ST_DATA TO DT_DATA_FINAL
CALC (DT_DATA_FINAL - 1) TO DT_DATA_FINAL

PAGE TELA

//--seleciona pasta para gravacao do arquivo
PASTA_CAMINHO ST_ARQUIVO 'TEXTOS' ' ' ST@CODIGO@ENTIDADE

// chamar programa para atualizar depara
MOVE 0 TO CURRENT_IMAGE
PAGE TELA
MOVE 'ATZ_SIOP_CLIENTE ' TO ST_JUNTA
APPEND ST_JUNTA 'SFPM'
CHAIN WAIT ST_JUNTA EXPORT_ONLY
GET_CURRENT_DIRECTORY TO ST_JUNTA
APPEND ST_JUNTA '/relsiop'
ERASEFILE ST_JUNTA
//--

MOVE 0 TO CURRENT_IMAGE
PAGE MSG

//--verificacao
GOSUB LB_VERIFICACAO
PAGE TELA
PAGE MSG
//--

APAGA_TEMPCALC JN_LENDO

MOVE 0 TO IT_ORDEM

//--monta temporario
//--movimento de receita pegar at┌ mes 13, no mes 14 ┌ efetuado o encerramento
[ LE_XML!] BEGIN
            MOVE JN_MES TO IT_MES_FINAL

            FOR IT_MES FROM 1 TO IT_MES_FINAL
             MOVE IT_MES TO ST_MES_BUSCA
             COMZEROS ST_MES_BUSCA 2

             CLEAR CONTACOR
             CONSTRAINT_SET 1
             CONSTRAIN CONTACOR.ANO                    EQ ST_EXERCICIO
             CONSTRAIN CONTACOR.MES                    EQ ST_MES_BUSCA
             [~TCEMG!] CONSTRAIN CONTACOR.XML          EQ '06'
             [ TCEMG!] CONSTRAIN CONTACOR.XML          EQ '12'
             [~TODAS!] CONSTRAIN CONTACOR.COD_ENTIDADE EQ ST_ENTIDADE_SELECAO
                       CONSTRAIN CONTACOR.COD_ENTIDADE NE ST_PROPRIA_ENTIDADE
             CONSTRAINED_FIND FIRST CONTACOR BY INDEX.4
             WHILE [FOUND]
               CALC (JN_LENDO + 1) TO JN_LENDO
               KEYCHECK GOSUB LB_ROTINA_PARADA
               
               CLEAR PLANO
               MOVE PARGERAL.ESTADO    TO PLANO.UF
               MOVE PARGERAL.EXERCICIO TO PLANO.ANO
               MOVE CONTACOR.CONTA     TO PLANO.CODIGO
               FIND EQ PLANO BY INDEX.1
               [~FOUND] CLEAR PLANO
               
               INDICATE DEVEDORA! AS PLANO.SALDO_DC EQ 'D'
               
               INDICATE RECEITA_DEDUTORIA_PREVISTA! FALSE
               IF (((LEFT(PLANO.CODIGO,1)) EQ '5') AND (PLANO.SALDO_DC EQ 'C')) INDICATE RECEITA_DEDUTORIA_PREVISTA! TRUE
               
               MOVEALL 0 TO NB_ARRECADADO NB_ARRECADADO_DEDUCAO NB_ARRECADADO_FUNDEB NB_PREVISTO_ATUALIZADO NB_PREVISTO_INICIAL NB_REALIZADA_BASE NB_TOTAL_LIQUIDO NB_VALOR
             
               MOVEALL '' TO ST_COD_RECEITA ST_COD_PADRAO ST_COD_RECEITA_SIOPS
               
               [~TCEMG!] BEGIN
                          MOVE (MID(CONTACOR.DADOS,2,37)) TO ST_FONTE_RECURSO
                          MOVE (MID(CONTACOR.DADOS,7,43)) TO ST_COD_APLICACAO
                         END
               
               [~@NOVO_CNR!] APPEND ST_COD_RECEITA (MID(CONTACOR.DADOS,16,20)) '0'
               [ @NOVO_CNR!] APPEND ST_COD_RECEITA (MID(CONTACOR.DADOS,14,20)) '.0000'
             
               MOVE (OBTER_CODIGO_PADRAO_RECEITA(ST_COD_RECEITA,PARGERAL.EXERCICIO)) TO ST_COD_PADRAO
             
               BUSCA_CODIGO_SIOPS ST_COD_RECEITA ST_COD_PADRAO ST_COD_RECEITA_SIOPS
               
               INDICATE SAUDE! TRUE
               
               //--receita prevista pelo bruto
               IF PARGERAL.EXERCICIO GE '2020' BEGIN
                                                [ RECEITA_DEDUTORIA_PREVISTA!] INDICATE SAUDE! FALSE
                                               END
               
               [ SAUDE!] BEGIN
                          INDICATE PREVISTO_INICIAL!          AS (LEFT(CONTACOR.CONTA,9))  IN '5.2.1.1.1-5.2.1.1.2'
                          INDICATE PREVISTO_ATUALIZADO!       AS (LEFT(CONTACOR.CONTA,9))  IN '5.2.1.2.1-5.2.1.2.9'
                          INDICATE ARRECADADO!                AS (LEFT(CONTACOR.CONTA,7))  IN '6.2.1.2'
                          INDICATE ARRECADADO_DEDUCAO_FUNDEB! AS (LEFT(CONTACOR.CONTA,12)) IN '6.2.1.3.1.01'
                          INDICATE ARRECADADO_DEDUCAO!        AS (LEFT(CONTACOR.CONTA,9))  IN '6.2.1.3.2-6.2.1.3.3-6.2.1.3.4-6.2.1.3.5-6.2.1.3.6-6.2.1.3.9'
                          
                          [ PREVISTO_INICIAL!] BEGIN
                                                CALC (NB_PREVISTO_INICIAL    + (CONTACOR.VALOR_1 - CONTACOR.VALOR_2)) TO NB_PREVISTO_INICIAL
                                                CALC (NB_PREVISTO_ATUALIZADO + (CONTACOR.VALOR_1 - CONTACOR.VALOR_2)) TO NB_PREVISTO_ATUALIZADO
                                               END
                          [ PREVISTO_ATUALIZADO!] BEGIN
                                                   CALC (NB_PREVISTO_ATUALIZADO + (CONTACOR.VALOR_1 - CONTACOR.VALOR_2)) TO NB_PREVISTO_ATUALIZADO
                                                  END
                          [ ARRECADADO!] BEGIN
                                          [ DEVEDORA!] CALC (NB_ARRECADADO + (CONTACOR.VALOR_1 - CONTACOR.VALOR_2)) TO NB_ARRECADADO
                                          [~DEVEDORA!] CALC (NB_ARRECADADO + (CONTACOR.VALOR_2 - CONTACOR.VALOR_1)) TO NB_ARRECADADO
                                         END
                          [ ARRECADADO_DEDUCAO_FUNDEB!] BEGIN
                                                         [ DEVEDORA!] CALC (NB_ARRECADADO_FUNDEB + (CONTACOR.VALOR_1 - CONTACOR.VALOR_2)) TO NB_ARRECADADO_FUNDEB
                                                         [~DEVEDORA!] CALC (NB_ARRECADADO_FUNDEB + (CONTACOR.VALOR_2 - CONTACOR.VALOR_1)) TO NB_ARRECADADO_FUNDEB
                                                        END
                          [ ARRECADADO_DEDUCAO!] BEGIN
                                                  [ DEVEDORA!] CALC (NB_ARRECADADO_DEDUCAO + (CONTACOR.VALOR_1 - CONTACOR.VALOR_2)) TO NB_ARRECADADO_DEDUCAO
                                                  [~DEVEDORA!] CALC (NB_ARRECADADO_DEDUCAO + (CONTACOR.VALOR_2 - CONTACOR.VALOR_1)) TO NB_ARRECADADO_DEDUCAO
                                                 END
                          
                          CALC (NB_ARRECADADO - NB_ARRECADADO_DEDUCAO)                        TO NB_REALIZADA_BASE
                          CALC (NB_ARRECADADO - NB_ARRECADADO_DEDUCAO - NB_ARRECADADO_FUNDEB) TO NB_TOTAL_LIQUIDO
                        
                          CLEAR TEMPCALC
                          MOVE ST@CODIGO@ENTIDADE      TO TEMPCALC.COD_ENTIDADE
                          MOVE ST@EXERCICIO@FINANCEIRO TO TEMPCALC.EXERCICIO
                          MOVE ST@USUARIO              TO TEMPCALC.USUARIO
                          MOVE ST_COD_RECEITA_SIOPS    TO TEMPCALC.CODIGO
                          MOVE 'REC_SIOPS'             TO TEMPCALC.NUMERO
                          FIND EQ TEMPCALC BY INDEX.1
                          INDICATE ERR FALSE
                          ON ERROR GOSUB CHECA_GRAVACAO
                          [ FOUND] REREAD TEMPCALC
                          CALC (TEMPCALC.VALOR_1 + NB_PREVISTO_INICIAL)    TO TEMPCALC.VALOR_1
                          CALC (TEMPCALC.VALOR_2 + NB_PREVISTO_ATUALIZADO) TO TEMPCALC.VALOR_2
                          CALC (TEMPCALC.VALOR_3 + NB_ARRECADADO)          TO TEMPCALC.VALOR_3
                          CALC (TEMPCALC.VALOR_4 + NB_ARRECADADO_DEDUCAO)  TO TEMPCALC.VALOR_4
                          CALC (TEMPCALC.VALOR_5 + NB_REALIZADA_BASE)      TO TEMPCALC.VALOR_5
                          CALC (TEMPCALC.VALOR_6 + NB_ARRECADADO_FUNDEB)   TO TEMPCALC.VALOR_6
                          CALC (TEMPCALC.VALOR_7 + NB_TOTAL_LIQUIDO)       TO TEMPCALC.VALOR_7
                          MOVE 'ANALITICA'                                 TO TEMPCALC.AUXILIAR
                          SAVERECORD TEMPCALC
                          UNLOCK
                          ON ERROR OFF
                          
                          //--
                          //--codiv 19
                          //--
                          INDICATE COVID! AS (MID(ST_COD_APLICACAO,3,1)) EQ '312'
                          
                          [ COVID!] BEGIN
                                     MOVE (TRIM(ST_FONTE_RECURSO)) TO ST_AUX
                                     APPEND ST_AUX ' ' (MID(ST_COD_APLICACAO,3,1)) 'XXXX'
                                     
                                     MOVE 0 TO IT_AUX
                                     FOR IT_AUX FROM 1 TO 3
                                             IF IT_AUX EQ 1 MOVE 'COVID_R_PROPRIO' TO ST_NATUREZA
                                        ELSE IF IT_AUX EQ 2 MOVE 'COVID_R_ESTADO'  TO ST_NATUREZA
                                        ELSE IF IT_AUX EQ 3 MOVE 'COVID_R_UNIAO'   TO ST_NATUREZA
                                        
                                        CLEAR RELSIOP
                                        MOVE PARGERAL.ESTADO    TO RELSIOP.UF
                                        MOVE PARGERAL.EXERCICIO TO RELSIOP.ANO
                                        MOVE 'SIOPS'            TO RELSIOP.SISTEMA
                                        MOVE ST_NATUREZA        TO RELSIOP.NATUREZA
                                        MOVE ST_AUX             TO RELSIOP.CODIGO_TCE
                                        MOVE ''                 TO RELSIOP.CNR
                                        FIND EQ RELSIOP BY INDEX.2
                                        [ FOUND] BEGIN
                                                  CLEAR TEMPCALC
                                                  MOVE ST@CODIGO@ENTIDADE      TO TEMPCALC.COD_ENTIDADE
                                                  MOVE ST@EXERCICIO@FINANCEIRO TO TEMPCALC.EXERCICIO
                                                  MOVE ST@USUARIO              TO TEMPCALC.USUARIO
                                                  MOVE RELSIOP.CODIGO_SIOP     TO TEMPCALC.CODIGO
                                                  MOVE RELSIOP.NATUREZA        TO TEMPCALC.NUMERO
                                                  FIND EQ TEMPCALC BY INDEX.1
                                                  INDICATE ERR FALSE
                                                  ON ERROR GOSUB CHECA_GRAVACAO
                                                  [ FOUND] REREAD TEMPCALC
                                                  CALC (TEMPCALC.VALOR_7 + NB_TOTAL_LIQUIDO) TO TEMPCALC.VALOR_7
                                                  MOVE 'ANALITICA'                           TO TEMPCALC.AUXILIAR
                                                  SAVERECORD TEMPCALC
                                                  UNLOCK
                                                  ON ERROR OFF
                                                 END
                                     LOOP
                                    END
                         END
                       
               CONSTRAINT_SET 1         
               CONSTRAINED_FIND NEXT
               END
             CONSTRAINT_SET 1 CLEAR
            LOOP 
           END  

//--
[ LE_MOV!] BEGIN
            CLEAR MOVREC
            CONSTRAINT_SET 1
            CONSTRAIN MOVREC.COD_ENTIDADE EQ ST@CODIGO@ENTIDADE
            CONSTRAIN MOVREC.EXERCICIO    EQ ST@EXERCICIO@FINANCEIRO
            CONSTRAIN MOVREC.TIPO         EQ 'A'
            CONSTRAINED_FIND FIRST MOVREC BY INDEX.1
            WHILE [FOUND]
             CALC (JN_LENDO + 1) TO JN_LENDO
             KEYCHECK GOSUB LB_ROTINA_PARADA
             
             MOVEALL 0 TO NB_ARRECADADO NB_ARRECADADO_DEDUCAO NB_ARRECADADO_FUNDEB NB_PREVISTO_ATUALIZADO NB_PREVISTO_INICIAL NB_REALIZADA_BASE NB_TOTAL_LIQUIDO NB_VALOR
             
             MOVEALL '' TO ST_COD_RECEITA ST_COD_PADRAO ST_COD_RECEITA_SIOPS
             
             INDICATE RECEITA_DEDUTORIA! AS (LEFT(MOVREC.CODIGO,1)) EQ '9'
             INDICATE    DEDUCAO_FUNDEB! AS (LEFT(MOVREC.CODIGO,3)) EQ '9.5'
             INDICATE    DEDUCAO_OUTRAS! AS (((LEFT(MOVREC.CODIGO,1)) EQ '9') AND ((LEFT(MOVREC.CODIGO,3)) NE '9.5'))
             
             [~RECEITA_DEDUTORIA!] MOVE MOVREC.CODIGO                              TO ST_COD_RECEITA
             [ RECEITA_DEDUTORIA!] MOVE MOVREC.COD_DIV_ATIVA                       TO ST_COD_RECEITA
             MOVE (OBTER_CODIGO_PADRAO_RECEITA(ST_COD_RECEITA,PARGERAL.EXERCICIO)) TO ST_COD_PADRAO
             
             BUSCA_CODIGO_SIOPS ST_COD_RECEITA ST_COD_PADRAO ST_COD_RECEITA_SIOPS
             
             CLEAR RECEITAS
             MOVE PARGERAL.ESTADO    TO RECEITAS.UF
             MOVE PARGERAL.EXERCICIO TO RECEITAS.ANO
             MOVE ST_COD_PADRAO      TO RECEITAS.CODIGO
             FIND EQ RECEITAS BY INDEX.1
             [~FOUND] CLEAR RECEITAS
             
             INDICATE RENDIMENTO_APLICACAO! AS RECEITAS.REND_APLICACAO EQ 'S'
             
             INDICATE SAUDE! TRUE
             INDICATE    OK! TRUE
             
             //--receita prevista pelo bruto
             IF PARGERAL.EXERCICIO GE '2020' BEGIN
                                              [ RECEITA_DEDUTORIA!] INDICATE OK! FALSE
                                             END
             
             [ SAUDE!] BEGIN
                        [ OK!] BEGIN
                                MOVE MOVREC.VALOR_ORCADO TO NB_PREVISTO_INICIAL
                                MOVE NB_PREVISTO_INICIAL TO NB_PREVISTO_ATUALIZADO

                                CLEAR ATUAREC
                                CONSTRAINT_SET 2
                                CONSTRAIN ATUAREC.COD_ENTIDADE EQ ST@CODIGO@ENTIDADE
                                CONSTRAIN ATUAREC.EXERCICIO    EQ ST@EXERCICIO@FINANCEIRO
                                CONSTRAIN ATUAREC.N_RECEITA    EQ MOVREC.NUMERO
                                CONSTRAIN ATUAREC.DATA         LE DT_DATA_FINAL
                                CONSTRAINED_FIND FIRST ATUAREC BY INDEX.1
                                WHILE [FOUND]
                                 KEYCHECK GOSUB LB_ROTINA_PARADA
                                 CALC (JN_LENDO + 1) TO JN_LENDO

                                 CALC (NB_PREVISTO_ATUALIZADO + ATUAREC.VALOR) TO NB_PREVISTO_ATUALIZADO

                                 CONSTRAINT_SET 2
                                 CONSTRAINED_FIND NEXT
                                END
                                CONSTRAINT_SET 2 CLEAR
                               END
                        
                        CLEAR MOVDREC
                        CONSTRAINT_SET 3
                        CONSTRAIN MOVDREC.COD_ENTIDADE EQ ST@CODIGO@ENTIDADE
                        CONSTRAIN MOVDREC.EXERCICIO    EQ ST@EXERCICIO@FINANCEIRO
                        CONSTRAIN MOVDREC.N_RECEITA    EQ MOVREC.NUMERO
                        CONSTRAIN MOVDREC.DATA         LE DT_DATA_FINAL
                        CONSTRAINED_FIND FIRST MOVDREC BY INDEX.2
                        WHILE [FOUND]
                         KEYCHECK GOSUB LB_ROTINA_PARADA
                         CALC (JN_LENDO + 1) TO JN_LENDO
                         
                         [~RECEITA_DEDUTORIA!] CALC (NB_ARRECADADO         + MOVDREC.VALOR) TO NB_ARRECADADO
                         [    DEDUCAO_FUNDEB!] CALC (NB_ARRECADADO_FUNDEB  + MOVDREC.VALOR) TO NB_ARRECADADO_FUNDEB
                         [    DEDUCAO_OUTRAS!] CALC (NB_ARRECADADO_DEDUCAO + MOVDREC.VALOR) TO NB_ARRECADADO_DEDUCAO
 
                         CONSTRAINT_SET 3
                         CONSTRAINED_FIND NEXT
                        END
                        CONSTRAINT_SET 3 CLEAR
                        
                        CALC (NB_ARRECADADO_DEDUCAO * (-1)) TO NB_ARRECADADO_DEDUCAO
                        CALC (NB_ARRECADADO_FUNDEB  * (-1)) TO NB_ARRECADADO_FUNDEB
                        
                        CALC (NB_ARRECADADO - NB_ARRECADADO_DEDUCAO)                        TO NB_REALIZADA_BASE
                        CALC (NB_ARRECADADO - NB_ARRECADADO_DEDUCAO - NB_ARRECADADO_FUNDEB) TO NB_TOTAL_LIQUIDO
                        
                        CLEAR TEMPCALC
                        MOVE ST@CODIGO@ENTIDADE      TO TEMPCALC.COD_ENTIDADE
                        MOVE ST@EXERCICIO@FINANCEIRO TO TEMPCALC.EXERCICIO
                        MOVE ST@USUARIO              TO TEMPCALC.USUARIO
                        MOVE ST_COD_RECEITA_SIOPS    TO TEMPCALC.CODIGO
                        MOVE 'REC_SIOPS'             TO TEMPCALC.NUMERO
                        FIND EQ TEMPCALC BY INDEX.1
                        INDICATE ERR FALSE
                        ON ERROR GOSUB CHECA_GRAVACAO
                        [ FOUND] REREAD TEMPCALC
                        CALC (TEMPCALC.VALOR_1 + NB_PREVISTO_INICIAL)    TO TEMPCALC.VALOR_1
                        CALC (TEMPCALC.VALOR_2 + NB_PREVISTO_ATUALIZADO) TO TEMPCALC.VALOR_2
                        CALC (TEMPCALC.VALOR_3 + NB_ARRECADADO)          TO TEMPCALC.VALOR_3
                        CALC (TEMPCALC.VALOR_4 + NB_ARRECADADO_DEDUCAO)  TO TEMPCALC.VALOR_4
                        CALC (TEMPCALC.VALOR_5 + NB_REALIZADA_BASE)      TO TEMPCALC.VALOR_5
                        CALC (TEMPCALC.VALOR_6 + NB_ARRECADADO_FUNDEB)   TO TEMPCALC.VALOR_6
                        CALC (TEMPCALC.VALOR_7 + NB_TOTAL_LIQUIDO)       TO TEMPCALC.VALOR_7
                        MOVE 'ANALITICA'                                 TO TEMPCALC.AUXILIAR
                        SAVERECORD TEMPCALC
                        UNLOCK
                        ON ERROR OFF

                        //--
                        //--codiv 19
                        //--
                        CLEAR FONTREC
                        MOVE ST@CODIGO@ENTIDADE      TO FONTREC.COD_ENTIDADE
                        MOVE ST@EXERCICIO@FINANCEIRO TO FONTREC.EXERCICIO
                        MOVE 'RO'                    TO FONTREC.NATUREZA
                        MOVE MOVREC.NUMERO           TO FONTREC.CODIGO
                        REPEAT
                         FIND GT FONTREC BY INDEX.5
                         [ FOUND] INDICATE FOUND AS FONTREC.COD_ENTIDADE EQ ST@CODIGO@ENTIDADE
                         [ FOUND] INDICATE FOUND AS FONTREC.EXERCICIO    EQ ST@EXERCICIO@FINANCEIRO
                         [ FOUND] INDICATE FOUND AS FONTREC.NATUREZA     EQ 'RO'
                         [ FOUND] INDICATE FOUND AS FONTREC.CODIGO       EQ MOVREC.NUMERO
                         [ FOUND] BEGIN
                                   CLEAR FUNDOS
                                   MOVE ST@CODIGO@ENTIDADE      TO FUNDOS.COD_ENTIDADE
                                   MOVE ST@EXERCICIO@FINANCEIRO TO FUNDOS.EXERCICIO
                                   MOVE ST@TIPO@FONTE           TO FUNDOS.TIPO
                                   MOVE FONTREC.N_FUNDO         TO FUNDOS.CODIGO
                                   FIND EQ FUNDOS BY INDEX.1
                                   [~FOUND] CLEAR FUNDOS
                                   
                                   MOVE FONTREC.N_FONTE TO ST_FONTE_RECURSO
                                   MOVE FONTREC.N_FUNDO TO ST_COD_APLICACAO
                                   
                                             INDICATE COVID! AS (MID(ST_COD_APLICACAO,3,1)) EQ '312'
                                   [~COVID!] INDICATE COVID! AS FUNDOS.TIPO_PLANO           EQ 'S'
                                   [ COVID!] BEGIN
                                              MOVE (TRIM(ST_FONTE_RECURSO)) TO ST_AUX
                                              
                                              IF (MID(ST_COD_APLICACAO,3,1)) EQ '312' APPEND ST_AUX ' ' (MID(ST_COD_APLICACAO,3,1)) 'XXXX'
                                              ELSE                                    APPEND ST_AUX ' ' 'XXXXXXX'
                                              
                                              MOVE 0 TO IT_AUX
                                              FOR IT_AUX FROM 1 TO 3
                                                      IF IT_AUX EQ 1 MOVE 'COVID_R_PROPRIO' TO ST_NATUREZA
                                                 ELSE IF IT_AUX EQ 2 MOVE 'COVID_R_ESTADO'  TO ST_NATUREZA
                                                 ELSE IF IT_AUX EQ 3 MOVE 'COVID_R_UNIAO'   TO ST_NATUREZA
                                                 
                                                 CLEAR RELSIOP
                                                 MOVE PARGERAL.ESTADO    TO RELSIOP.UF
                                                 MOVE PARGERAL.EXERCICIO TO RELSIOP.ANO
                                                 MOVE 'SIOPS'            TO RELSIOP.SISTEMA
                                                 MOVE ST_NATUREZA        TO RELSIOP.NATUREZA
                                                 MOVE ST_AUX             TO RELSIOP.CODIGO_TCE
                                                 MOVE ''                 TO RELSIOP.CNR
                                                 FIND EQ RELSIOP BY INDEX.2
                                                 [ FOUND] BEGIN
                                                           CLEAR TEMPCALC
                                                           MOVE ST@CODIGO@ENTIDADE      TO TEMPCALC.COD_ENTIDADE
                                                           MOVE ST@EXERCICIO@FINANCEIRO TO TEMPCALC.EXERCICIO
                                                           MOVE ST@USUARIO              TO TEMPCALC.USUARIO
                                                           MOVE RELSIOP.CODIGO_SIOP     TO TEMPCALC.CODIGO
                                                           MOVE RELSIOP.NATUREZA        TO TEMPCALC.NUMERO
                                                           FIND EQ TEMPCALC BY INDEX.1
                                                           INDICATE ERR FALSE
                                                           ON ERROR GOSUB CHECA_GRAVACAO
                                                           [ FOUND] REREAD TEMPCALC
                                                           CALC (TEMPCALC.VALOR_7 + NB_TOTAL_LIQUIDO) TO TEMPCALC.VALOR_7
                                                           MOVE 'ANALITICA'                           TO TEMPCALC.AUXILIAR
                                                           SAVERECORD TEMPCALC
                                                           UNLOCK
                                                           ON ERROR OFF
                                                          END
                                              LOOP
                                             END
                                   
                                   INDICATE FOUND TRUE
                                  END
                        UNTIL [~FOUND]
                       END

             CONSTRAINT_SET 1         
             CONSTRAINED_FIND NEXT
            END
            CONSTRAINT_SET 1 CLEAR
            
            //--orcado proximo exercicio
            IF JN_MES EQ '12' BEGIN
                               MOVE 0 TO IT_VERSAO_LOA
                               CLEAR VERSAO
                               MOVE 'LOA'                    TO VERSAO.TIPO
                               MOVE 'A'                      TO VERSAO.ATIVO
                               MOVE (PARGERAL.EXERCICIO + 1) TO VERSAO.ANO_VIGENCIA_I
                               MOVE 2                        TO VERSAO.NUMERO
                               FIND EQ VERSAO BY INDEX.2
                               [ FOUND] BEGIN
                                         MOVE VERSAO.ID_VERSAO TO IT_VERSAO_LOA
                               
                                         CLEAR PLANREC
                                         CONSTRAINT_SET 1
                                         CONSTRAIN PLANREC.ID_VERSAO EQ IT_VERSAO_LOA
                                         [~TODAS!] CONSTRAIN PLANREC.COD_ENTIDADE EQ ST_ENTIDADE_SELECAO
                                         CONSTRAIN PLANREC.TIPO EQ 'A'
                                         CONSTRAINED_FIND FIRST PLANREC BY INDEX.6
                                         WHILE [FOUND]
                                          CALC (JN_LENDO + 1) TO JN_LENDO
                                          KEYCHECK GOSUB LB_ROTINA_PARADA
                                          
                                          MOVEALL '' TO ST_COD_RECEITA ST_COD_PADRAO ST_COD_RECEITA_SIOPS
                                          
                                          INDICATE RECEITA_DEDUTORIA! AS (LEFT(PLANREC.CODIGO,1)) EQ '9'
                                          INDICATE    DEDUCAO_FUNDEB! AS (LEFT(PLANREC.CODIGO,3)) EQ '9.5'
                                          INDICATE    DEDUCAO_OUTRAS! AS (((LEFT(PLANREC.CODIGO,1)) EQ '9') AND ((LEFT(PLANREC.CODIGO,3)) NE '9.5'))
                                          
                                          [~RECEITA_DEDUTORIA!] MOVE PLANREC.CODIGO                             TO ST_COD_RECEITA
                                          [ RECEITA_DEDUTORIA!] MOVE PLANREC.COD_DIV_ATIVA                      TO ST_COD_RECEITA
                                          MOVE (OBTER_CODIGO_PADRAO_RECEITA(ST_COD_RECEITA,PARGERAL.EXERCICIO)) TO ST_COD_PADRAO
                                          
                                          BUSCA_CODIGO_SIOPS ST_COD_RECEITA ST_COD_PADRAO ST_COD_RECEITA_SIOPS
                                          
                                          INDICATE OK! TRUE
                                          
                                          //--receita prevista pelo bruto
                                          IF PARGERAL.EXERCICIO GE '2020' BEGIN
                                                                           [ RECEITA_DEDUTORIA!] INDICATE OK! FALSE
                                                                          END
                                          
                                          [ OK!] BEGIN
                                                  MOVE PLANREC.VALOR_ORCADO TO NB_PREVISTO_INICIAL
                                                  MOVE NB_PREVISTO_INICIAL TO NB_PREVISTO_ATUALIZADO
                                                  
                                                  CLEAR TEMPCALC
                                                  MOVE ST@CODIGO@ENTIDADE      TO TEMPCALC.COD_ENTIDADE
                                                  MOVE ST@EXERCICIO@FINANCEIRO TO TEMPCALC.EXERCICIO
                                                  MOVE ST@USUARIO              TO TEMPCALC.USUARIO
                                                  MOVE ST_COD_RECEITA_SIOPS    TO TEMPCALC.CODIGO
                                                  MOVE 'REC_SIOPS'             TO TEMPCALC.NUMERO
                                                  FIND EQ TEMPCALC BY INDEX.1
                                                  INDICATE ERR FALSE
                                                  ON ERROR GOSUB CHECA_GRAVACAO
                                                  [ FOUND] REREAD TEMPCALC
                                                  CALC (TEMPCALC.VALOR_8 + PLANREC.VALOR_ORCADO) TO TEMPCALC.VALOR_8
                                                  MOVE 'ANALITICA'                               TO TEMPCALC.AUXILIAR
                                                  SAVERECORD TEMPCALC
                                                  UNLOCK
                                                  ON ERROR OFF
                                                 END
                                          
                                          CONSTRAINT_SET 1
                                          CONSTRAINED_FIND NEXT
                                          END
                                         CONSTRAINT_SET 1 CLEAR
                                        END
                              END
           END

//--
//--
//--geracao do arquivo texto
//--
MOVE ST_ARQUIVO TO ST_SAIDA
APPEND ST_SAIDA 'receita_siops_' PARGERAL.EXERCICIO '_' JN_MES '.impt'
TRIM ST_SAIDA TO ST_SAIDA
DIRECT_OUTPUT ST_SAIDA

CLEAR CADSIOP
CONSTRAINT_SET 1
CONSTRAIN CADSIOP.SISTEMA  EQ 'SIOPS'
CONSTRAIN CADSIOP.ANO      EQ PARGERAL.EXERCICIO
CONSTRAIN CADSIOP.NATUREZA EQ 'RECEITA'
CONSTRAINED_FIND FIRST CADSIOP BY INDEX.1
WHILE [FOUND]
 CALC (JN_LENDO + 1) TO JN_LENDO
 
 INDICATE IMPRIME! FALSE
 
 MOVE '1' TO ST_AUX
 
 CLEAR TEMPCALC
 MOVE ST@CODIGO@ENTIDADE      TO TEMPCALC.COD_ENTIDADE
 MOVE ST@EXERCICIO@FINANCEIRO TO TEMPCALC.EXERCICIO
 MOVE ST@USUARIO              TO TEMPCALC.USUARIO
 MOVE CADSIOP.CODIGO          TO TEMPCALC.CODIGO
 MOVE 'REC_SIOPS'             TO TEMPCALC.NUMERO
 FIND EQ TEMPCALC BY INDEX.1
 [ FOUND] BEGIN
           [~IMPRIME!] WRITE ST_AUX ';' (TRIM(TEMPCALC.CODIGO)) ';'  (TRIM(CADSIOP.CODIGO_ITEM)) ';' 
           
           WRITE 'V0:' '[>R$' TEMPCALC.VALOR_1 '<]' ':-[17];'
           WRITE 'V1:' '[>R$' TEMPCALC.VALOR_2 '<]' ':-[15];'
           WRITE 'V2:' '[>R$' TEMPCALC.VALOR_3 '<]' ':-[18];'
           WRITE 'V3:' '[>R$' TEMPCALC.VALOR_4 '<]' ':-[6];'
           WRITE 'V4:' '[>R$' TEMPCALC.VALOR_5 '<]' ':-[20];'
           WRITE 'V5:' '[>R$' TEMPCALC.VALOR_6 '<]' ':-[5];'
           WRITE 'V6:' '[>R$' TEMPCALC.VALOR_7 '<]' ':-[24];'
           
           IF JN_MES EQ '12' BEGIN
                              WRITE 'V7:' '[>R$' TEMPCALC.VALOR_8 '<]' ':-[22];'
                             END
           
           INDICATE IMPRIME! TRUE
          END
  
 [ IMPRIME!] WRITELN (TRIM(CADSIOP.L_ADM_D)) ';' (TRIM(CADSIOP.C_ADM_D))
 
 CONSTRAINT_SET 1
 CONSTRAINED_FIND NEXT
 END
CONSTRAINT_SET 1 CLEAR
CLOSE_OUTPUT ST_SAIDA

//--
//--textos do covid nao tem mais em 2024 e 23
//--
IF PARGERAL.EXERCICIO LE '2022' BEGIN
  //--covid recurso proprio
  MOVE ST_ARQUIVO TO ST_SAIDA
  APPEND ST_SAIDA 'receita_siops_covid_proprio_' PARGERAL.EXERCICIO '_' JN_MES '.impt'
  TRIM ST_SAIDA TO ST_SAIDA
  DIRECT_OUTPUT ST_SAIDA

  CLEAR CADSIOP
  CONSTRAINT_SET 1
  CONSTRAIN CADSIOP.SISTEMA  EQ 'SIOPS'
  CONSTRAIN CADSIOP.ANO      EQ PARGERAL.EXERCICIO
  CONSTRAIN CADSIOP.NATUREZA EQ 'COVID_R_PROPRIO'
  CONSTRAINED_FIND FIRST CADSIOP BY INDEX.1
  WHILE [FOUND]
   CALC (JN_LENDO + 1) TO JN_LENDO
   
   INDICATE IMPRIME! FALSE
   
   MOVE (TRIM(CADSIOP.PASTA_RESP)) TO ST_AUX
   
   CLEAR TEMPCALC
   MOVE ST@CODIGO@ENTIDADE      TO TEMPCALC.COD_ENTIDADE
   MOVE ST@EXERCICIO@FINANCEIRO TO TEMPCALC.EXERCICIO
   MOVE ST@USUARIO              TO TEMPCALC.USUARIO
   MOVE CADSIOP.CODIGO          TO TEMPCALC.CODIGO
   MOVE CADSIOP.NATUREZA        TO TEMPCALC.NUMERO
   FIND EQ TEMPCALC BY INDEX.1
   [ FOUND] BEGIN
             WRITE ST_AUX ';' (TRIM(TEMPCALC.CODIGO)) ';'  (TRIM(CADSIOP.CODIGO_ITEM)) ';' 'V0:' '[>R$' TEMPCALC.VALOR_7 '<]' ':-[260];'
             
             INDICATE IMPRIME! TRUE
            END
    
   [ IMPRIME!] WRITELN (TRIM(CADSIOP.L_ADM_D)) ';' (TRIM(CADSIOP.C_ADM_D))
   
   CONSTRAINT_SET 1
   CONSTRAINED_FIND NEXT
   END
  CONSTRAINT_SET 1 CLEAR
  CLOSE_OUTPUT ST_SAIDA

  //--covid recurso estado
  MOVE ST_ARQUIVO TO ST_SAIDA
  APPEND ST_SAIDA 'receita_siops_covid_estado_' PARGERAL.EXERCICIO '_' JN_MES '.impt'
  TRIM ST_SAIDA TO ST_SAIDA
  DIRECT_OUTPUT ST_SAIDA

  CLEAR CADSIOP
  CONSTRAINT_SET 1
  CONSTRAIN CADSIOP.SISTEMA  EQ 'SIOPS'
  CONSTRAIN CADSIOP.ANO      EQ PARGERAL.EXERCICIO
  CONSTRAIN CADSIOP.NATUREZA EQ 'COVID_R_ESTADO'
  CONSTRAINED_FIND FIRST CADSIOP BY INDEX.1
  WHILE [FOUND]
   CALC (JN_LENDO + 1) TO JN_LENDO
   
   INDICATE IMPRIME! FALSE
   
   MOVE (TRIM(CADSIOP.PASTA_RESP)) TO ST_AUX
   
   CLEAR TEMPCALC
   MOVE ST@CODIGO@ENTIDADE      TO TEMPCALC.COD_ENTIDADE
   MOVE ST@EXERCICIO@FINANCEIRO TO TEMPCALC.EXERCICIO
   MOVE ST@USUARIO              TO TEMPCALC.USUARIO
   MOVE CADSIOP.CODIGO          TO TEMPCALC.CODIGO
   MOVE CADSIOP.NATUREZA        TO TEMPCALC.NUMERO
   FIND EQ TEMPCALC BY INDEX.1
   [ FOUND] BEGIN
             WRITE ST_AUX ';' (TRIM(TEMPCALC.CODIGO)) ';'  (TRIM(CADSIOP.CODIGO_ITEM)) ';' 'V0:' '[>R$' TEMPCALC.VALOR_7 '<]' ':-[260];'
             
             INDICATE IMPRIME! TRUE
            END
    
   [ IMPRIME!] WRITELN (TRIM(CADSIOP.L_ADM_D)) ';' (TRIM(CADSIOP.C_ADM_D))
   
   CONSTRAINT_SET 1
   CONSTRAINED_FIND NEXT
   END
  CONSTRAINT_SET 1 CLEAR
  CLOSE_OUTPUT ST_SAIDA

  //--covid recurso uniao
  MOVE ST_ARQUIVO TO ST_SAIDA
  APPEND ST_SAIDA 'receita_siops_covid_uniao_' PARGERAL.EXERCICIO '_' JN_MES '.impt'
  TRIM ST_SAIDA TO ST_SAIDA
  DIRECT_OUTPUT ST_SAIDA

  CLEAR CADSIOP
  CONSTRAINT_SET 1
  CONSTRAIN CADSIOP.SISTEMA  EQ 'SIOPS'
  CONSTRAIN CADSIOP.ANO      EQ PARGERAL.EXERCICIO
  CONSTRAIN CADSIOP.NATUREZA EQ 'COVID_R_UNIAO'
  CONSTRAINED_FIND FIRST CADSIOP BY INDEX.1
  WHILE [FOUND]
   CALC (JN_LENDO + 1) TO JN_LENDO
   
   INDICATE IMPRIME! FALSE
   
   MOVE (TRIM(CADSIOP.PASTA_RESP)) TO ST_AUX
   
   CLEAR TEMPCALC
   MOVE ST@CODIGO@ENTIDADE      TO TEMPCALC.COD_ENTIDADE
   MOVE ST@EXERCICIO@FINANCEIRO TO TEMPCALC.EXERCICIO
   MOVE ST@USUARIO              TO TEMPCALC.USUARIO
   MOVE CADSIOP.CODIGO          TO TEMPCALC.CODIGO
   MOVE CADSIOP.NATUREZA        TO TEMPCALC.NUMERO
   FIND EQ TEMPCALC BY INDEX.1
   [ FOUND] BEGIN
             WRITE ST_AUX ';' (TRIM(TEMPCALC.CODIGO)) ';'  (TRIM(CADSIOP.CODIGO_ITEM)) ';' 'V0:' '[>R$' TEMPCALC.VALOR_7 '<]' ':-[260];'
             
             INDICATE IMPRIME! TRUE
            END
    
   [ IMPRIME!] WRITELN (TRIM(CADSIOP.L_ADM_D)) ';' (TRIM(CADSIOP.C_ADM_D))
   
   CONSTRAINT_SET 1
   CONSTRAINED_FIND NEXT
   END
  CONSTRAINT_SET 1 CLEAR
  CLOSE_OUTPUT ST_SAIDA
END

//--
//--novo texto a partir de 2024
//--
IF PARGERAL.EXERCICIO GE '20242' BEGIN

END


APAGA_TEMPCALC JN_LENDO
ABORT

LB_VERIFICACAO:
 ABREREL_GERRELAT 'INCONSIST┬NCIAS P/ GERA─▌O DO SIOPS - RECEITA' '132C+' 'T'

 MOVE 1 TO PAGECOUNT
 MOVE 0 TO RECCOUNT

 CABEC ST@PREFEITURA JHD_PREFEITURA
 SYSDATA             JHD_DATA
 PRINT PAGECOUNT  TO JHD_PAGINA
 CABEC ST_PERIODO    JHD_PERIODO
 OUTPUT HEADER

 SCREENMODE IT_COR_TARJA ON
 PAGE MSG

 [ LE_XML!] BEGIN
             MOVE JN_MES TO IT_MES_FINAL

             FOR IT_MES FROM 1 TO IT_MES_FINAL
              MOVE IT_MES TO ST_MES_BUSCA
              COMZEROS ST_MES_BUSCA 2

              CLEAR CONTACOR
              CONSTRAINT_SET 1
              CONSTRAIN CONTACOR.ANO                    EQ ST_EXERCICIO
              CONSTRAIN CONTACOR.MES                    EQ ST_MES_BUSCA
              [~TCEMG!] CONSTRAIN CONTACOR.XML          EQ '06'
              [ TCEMG!] CONSTRAIN CONTACOR.XML          EQ '12'
              [~TODAS!] CONSTRAIN CONTACOR.COD_ENTIDADE EQ ST_ENTIDADE_SELECAO
                        CONSTRAIN CONTACOR.COD_ENTIDADE NE ST_PROPRIA_ENTIDADE
              CONSTRAINED_FIND FIRST CONTACOR BY INDEX.4
              WHILE [FOUND]
               CALC (JN_LENDO + 1) TO JN_LENDO
               KEYCHECK GOSUB LB_ROTINA_PARADA

               MOVEALL '' TO ST_COD_RECEITA ST_COD_RECEITA_SIOPS
               
               [~@NOVO_CNR!] APPEND ST_COD_RECEITA (MID(CONTACOR.DADOS,16,20)) '0'
               [ @NOVO_CNR!] APPEND ST_COD_RECEITA (MID(CONTACOR.DADOS,14,20)) '.0000'
                
               MOVE (OBTER_CODIGO_PADRAO_RECEITA(ST_COD_RECEITA,PARGERAL.EXERCICIO)) TO ST_COD_PADRAO
               
               IF (MID(ST_COD_PADRAO,1,1)) EQ '7' MOVE (OVERSTRIKE('1',ST_COD_PADRAO,1)) TO ST_COD_PADRAO
               IF (MID(ST_COD_PADRAO,1,1)) EQ '8' MOVE (OVERSTRIKE('2',ST_COD_PADRAO,1)) TO ST_COD_PADRAO
               
               BUSCA_CODIGO_SIOPS ST_COD_RECEITA ST_COD_PADRAO ST_COD_RECEITA_SIOPS
               
               IF ST_COD_RECEITA_SIOPS EQ '' BEGIN
                                              INCREMENT RECCOUNT
                                              MOVE 'COD. RECEITA ' TO ST_BODY
                                              APPEND ST_BODY ' ' ST_COD_RECEITA ' SEM RELACIONAMENTO COM O PLANO DE RECEITAS DO SIOPS ENT: ' CONTACOR.COD_ENTIDADE
                                              PRINT ST_BODY TO JBD_DESCRICAO
                                              OUTPUT BODY
                                              GOSUB LB_PULA_PAGINA
                                             END
               ELSE BEGIN
                     CLEAR CADSIOP
                     MOVE 'SIOPS'              TO CADSIOP.SISTEMA
                     MOVE PARGERAL.EXERCICIO   TO CADSIOP.ANO
                     MOVE 'RECEITA'            TO CADSIOP.NATUREZA
                     MOVE ST_COD_RECEITA_SIOPS TO CADSIOP.CODIGO
                     FIND EQ CADSIOP BY INDEX.1
                     [~FOUND] BEGIN
                               INCREMENT RECCOUNT
                             
                               MOVE 'COD. RECEITA ' TO ST_BODY
                               APPEND ST_BODY ' ' ST_COD_RECEITA_SIOPS ' INEXISTENTE NO CADASTRO DE RECEITAS DO SIOPS ENT: ' CONTACOR.COD_ENTIDADE
                               PRINT ST_BODY TO JBD_DESCRICAO
                               OUTPUT BODY
                               GOSUB LB_PULA_PAGINA
                              END
                     [ FOUND] BEGIN
                               IF CADSIOP.TIPO NE 'A' BEGIN
                                                       INCREMENT RECCOUNT
                                                     
                                                       MOVE 'COD. RECEITA ' TO ST_BODY
                                                       APPEND ST_BODY ' ' ST_COD_RECEITA_SIOPS ' COM TIPO DIFERENTE DE ANALITICA NO CADASTRO DO SIOPS ENT: ' CONTACOR.COD_ENTIDADE
                                                       PRINT ST_BODY TO JBD_DESCRICAO
                                                       OUTPUT BODY
                                                       GOSUB LB_PULA_PAGINA
                                                      END
                               IF CADSIOP.CODIGO_ITEM EQ '' BEGIN
                                                             INCREMENT RECCOUNT
                                                           
                                                             MOVE 'COD. RECEITA ' TO ST_BODY
                                                             APPEND ST_BODY ' ' ST_COD_RECEITA_SIOPS ' SEM CODIGO DE ITEM NO CADASTRO DO SIOPS ENT: ' CONTACOR.COD_ENTIDADE
                                                             PRINT ST_BODY TO JBD_DESCRICAO
                                                             OUTPUT BODY
                                                             GOSUB LB_PULA_PAGINA
                                                            END
                              END
                    END
                       
               CONSTRAINT_SET 1
               CONSTRAINED_FIND NEXT
               END
              CONSTRAINT_SET 1 CLEAR
             LOOP 
            END  

 //--
 [ LE_MOV!] BEGIN
             CLEAR MOVREC
             CONSTRAINT_SET 1
             CONSTRAIN MOVREC.COD_ENTIDADE EQ ST@CODIGO@ENTIDADE
             CONSTRAIN MOVREC.EXERCICIO    EQ ST@EXERCICIO@FINANCEIRO
             CONSTRAIN MOVREC.TIPO         EQ 'A'
             CONSTRAINED_FIND FIRST MOVREC BY INDEX.1
             WHILE [FOUND]
              CALC (JN_LENDO + 1) TO JN_LENDO
              KEYCHECK GOSUB LB_ROTINA_PARADA

              MOVEALL '' TO ST_COD_RECEITA ST_COD_PADRAO ST_COD_RECEITA_SIOPS
              
              INDICATE RECEITA_DEDUTORIA! AS (LEFT(MOVREC.CODIGO,1)) EQ '9'
              [~RECEITA_DEDUTORIA!] MOVE MOVREC.CODIGO                              TO ST_COD_RECEITA
              [ RECEITA_DEDUTORIA!] MOVE MOVREC.COD_DIV_ATIVA                       TO ST_COD_RECEITA
              MOVE (OBTER_CODIGO_PADRAO_RECEITA(ST_COD_RECEITA,PARGERAL.EXERCICIO)) TO ST_COD_PADRAO
              
              IF (MID(ST_COD_PADRAO,1,1)) EQ '7' MOVE (OVERSTRIKE('1',ST_COD_PADRAO,1)) TO ST_COD_PADRAO
              IF (MID(ST_COD_PADRAO,1,1)) EQ '8' MOVE (OVERSTRIKE('2',ST_COD_PADRAO,1)) TO ST_COD_PADRAO
              
              BUSCA_CODIGO_SIOPS ST_COD_RECEITA ST_COD_PADRAO ST_COD_RECEITA_SIOPS
              
              IF ST_COD_RECEITA_SIOPS EQ '' BEGIN
                                             INCREMENT RECCOUNT
                                           
                                             MOVE 'COD. RECEITA ' TO ST_BODY
                                             APPEND ST_BODY ' ' ST_COD_RECEITA ' SEM RELACIONAMENTO COM O PLANO DE RECEITAS DO SIOPS ENT: ' MOVREC.COD_ENTIDADE
                                             PRINT ST_BODY TO JBD_DESCRICAO
                                             OUTPUT BODY
                                             GOSUB LB_PULA_PAGINA
                                            END
              ELSE BEGIN
                    CLEAR CADSIOP
                    MOVE 'SIOPS'              TO CADSIOP.SISTEMA
                    MOVE PARGERAL.EXERCICIO   TO CADSIOP.ANO
                    MOVE 'RECEITA'            TO CADSIOP.NATUREZA
                    MOVE ST_COD_RECEITA_SIOPS TO CADSIOP.CODIGO
                    FIND EQ CADSIOP BY INDEX.1
                    [~FOUND] BEGIN
                              INCREMENT RECCOUNT
                            
                              MOVE 'COD. RECEITA ' TO ST_BODY
                              APPEND ST_BODY ' ' ST_COD_RECEITA_SIOPS ' INEXISTENTE NO CADASTRO DE RECEITAS DO SIOPS ENT: ' MOVREC.COD_ENTIDADE
                              PRINT ST_BODY TO JBD_DESCRICAO
                              OUTPUT BODY
                              GOSUB LB_PULA_PAGINA
                             END
                    [ FOUND] BEGIN
                              IF CADSIOP.TIPO NE 'A' BEGIN
                                                      INCREMENT RECCOUNT
                                                    
                                                      MOVE 'COD. RECEITA ' TO ST_BODY
                                                      APPEND ST_BODY ' ' ST_COD_RECEITA_SIOPS ' COM TIPO DIFERENTE DE ANALITICA NO CADASTRO DO SIOPS ENT: ' MOVREC.COD_ENTIDADE
                                                      PRINT ST_BODY TO JBD_DESCRICAO
                                                      OUTPUT BODY
                                                      GOSUB LB_PULA_PAGINA
                                                     END
                              IF CADSIOP.CODIGO_ITEM EQ '' BEGIN
                                                            INCREMENT RECCOUNT
                                                          
                                                            MOVE 'COD. RECEITA ' TO ST_BODY
                                                            APPEND ST_BODY ' ' ST_COD_RECEITA_SIOPS ' SEM CODIGO DE ITEM NO CADASTRO DO SIOPS ENT: ' MOVREC.COD_ENTIDADE
                                                            PRINT ST_BODY TO JBD_DESCRICAO
                                                            OUTPUT BODY
                                                            GOSUB LB_PULA_PAGINA
                                                           END
                             END
                   END

              CONSTRAINT_SET 1         
              CONSTRAINED_FIND NEXT
              END
             CONSTRAINT_SET 1 CLEAR
            END
 
 OUTPUT TOTAL
 BUSCA_CAMINHO_MENU 'GSIOPSR' ''
 FORMFEED
 GRAVAPAG 'C'

 IF RECCOUNT NE 0 BEGIN
                   ADVERTE 'VERIFIQUE RELAT╒RIO DE INCONSIST┬NCIAS DO SIOPS - RECEITA'
                   //ABORT
                  END
RETURN

//-----------------------------------------------------------

LB_ROTINA_PARADA:
 CABEC 'GOSTARIA REALMENTE DE SAIR < S/N >?' CONFIRMA.1
 PAGE CONFIRMA
 INKEYCHECK ST_TECLA IN 'SsNn'
 IF ST_TECLA IN 'Ss' BEGIN
                      MOVE 0 TO RECCOUNT
                      LIMPA_PRN
                     END
 
 MOVE 0 TO CURRENT_IMAGE
 PAGE TELA
 PAGE MSG
RETURN

LB_PULA_PAGINA:
 IF LINECOUNT GE 58 BEGIN
                     OUTPUT TOTAL
                     FORMFEED
                     PRINT PAGECOUNT TO JHD_PAGINA
                     OUTPUT HEADER
                    END
RETURN

KEYPROC KEY.UP
 IF CURRENT_WINDOW EQ 3 BEGIN
                         [ PREFE!] BACKFIELD
                         [~PREFE!] RETURN LB_MES
                        END
 ELSE BACKFIELD
RETURN

KEYPROC KEY.FIELD
 IF CURRENT_WINDOW EQ 1 BEGIN
                         MOVE 'CENTIDAD 1 ' TO ST_JUNTA
                         APPEND ST_JUNTA ST@USUARIO ' ' ST@OPCAO ' ' ST@PROGRAMA ' ' ST@CODIGO@ENTIDADE ' ' ST@EXERCICIO@FINANCEIRO
                         CHAIN WAIT ST_JUNTA EXPORT_FILES
                         MOVE 0 TO CURRENT_IMAGE
                         PAGE TELA
                         IF ENTIDADE.CODIGO NE "" BEGIN
                                                   TRIM ENTIDADE.CODIGO    TO JN_COD_ENTIDADE
                                                   TRIM ENTIDADE.DESCRICAO TO JN_ENTIDADE
                                                  END
                         ELSE ENTAGAIN
                         RETURN
                        END
 ENTAGAIN
RETURN


#INCLUDE INTEGRID.INC
